
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Readiness Checklist - Crusoe</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #111111;
            --bg-card: #161616;
            --accent: #c8ff00;
            --accent-dim: rgba(200, 255, 0, 0.15);
            --text-primary: #ffffff;
            --text-secondary: #888888;
            --text-muted: #555555;
            --border: rgba(255, 255, 255, 0.08);
            --border-hover: rgba(255, 255, 255, 0.15);
            --success: #c8ff00;
            --warning: #ffcc00;
            --error: #ff4444;
        }

        body {
            font-family: 'Space Grotesk', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            padding: 20px 28px;
            font-size: 14px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon::before {
            content: "✦";
            color: var(--bg-primary);
            font-size: 20px;
        }

        header h1 {
            font-family: 'Space Mono', monospace;
            font-size: 1.55rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        header p {
            font-family: 'Space Mono', monospace;
            color: var(--text-secondary);
            font-size: 1.05rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        /* Intro Section */
        .intro-section {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: calc(100vh - 80px);
            animation: fadeIn 0.6s ease-out;
            padding: 20px 40px;
            box-sizing: border-box;
            position: relative;
            overflow: hidden;
        }
        
        /* Background grid */
        .intro-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(rgba(200, 255, 0, 0.06) 1px, transparent 1px),
                linear-gradient(90deg, rgba(200, 255, 0, 0.06) 1px, transparent 1px);
            background-size: 80px 80px;
            pointer-events: none;
            z-index: 0;
        }
        
        /* Glowing orb top right */
        .intro-section::after {
            content: '';
            position: absolute;
            top: -300px;
            right: -300px;
            width: 800px;
            height: 800px;
            background: radial-gradient(circle, rgba(200, 255, 0, 0.12) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        /* Second glow bottom left */
        .bg-glow-bl {
            position: absolute;
            bottom: -200px;
            left: -200px;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(200, 255, 0, 0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        /* Power flow lines */
        .bg-lines {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }
        
        .bg-line {
            position: absolute;
            height: 2px;
            background: linear-gradient(90deg, transparent 0%, var(--accent) 50%, transparent 100%);
            opacity: 0.2;
            animation: flowLine 6s ease-in-out infinite;
        }
        
        .bg-line:nth-child(1) {
            top: 15%;
            left: 0;
            width: 50%;
            animation-delay: 0s;
        }
        
        .bg-line:nth-child(2) {
            top: 50%;
            right: 0;
            width: 40%;
            animation-delay: 2s;
        }
        
        .bg-line:nth-child(3) {
            top: 85%;
            left: 0;
            width: 30%;
            animation-delay: 4s;
        }
        
        .bg-line-vertical {
            position: absolute;
            width: 2px;
            background: linear-gradient(180deg, transparent 0%, var(--accent) 50%, transparent 100%);
            opacity: 0.15;
            animation: flowLineV 8s ease-in-out infinite;
        }
        
        .bg-line-vertical:nth-child(4) {
            left: 10%;
            top: 0;
            height: 40%;
            animation-delay: 1s;
        }
        
        .bg-line-vertical:nth-child(5) {
            right: 15%;
            bottom: 0;
            height: 35%;
            animation-delay: 3s;
        }
        
        @keyframes flowLine {
            0%, 100% { transform: translateX(-50px); opacity: 0; }
            50% { transform: translateX(50px); opacity: 0.3; }
        }
        
        @keyframes flowLineV {
            0%, 100% { transform: translateY(-30px); opacity: 0; }
            50% { transform: translateY(30px); opacity: 0.25; }
        }
        
        /* Circuit node dots */
        .bg-node {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            animation: pulse 4s ease-in-out infinite;
            box-shadow: 0 0 20px var(--accent);
        }
        
        .bg-node:nth-child(6) { top: 15%; left: 10%; animation-delay: 0s; }
        .bg-node:nth-child(7) { top: 50%; left: 5%; animation-delay: 1s; }
        .bg-node:nth-child(8) { top: 25%; right: 10%; animation-delay: 2s; }
        .bg-node:nth-child(9) { top: 75%; right: 8%; animation-delay: 0.5s; }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.1; transform: scale(0.8); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .intro-content {
            text-align: center;
            width: 100%;
            max-width: 100%;
            position: relative;
            z-index: 1;
        }

        .intro-headline {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            line-height: 1.2;
            color: var(--text-primary);
            margin-bottom: 24px;
            letter-spacing: -0.02em;
        }

        /* Structure Map */
        .structure-map {
            margin-bottom: 28px;
            width: 100%;
        }

        .map-header {
            text-align: center;
            margin-bottom: 16px;
        }

        .map-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.3em;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .map-subtitle {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.4rem;
            color: var(--text-primary);
            font-weight: 700;
            margin: 0;
        }
        
        .second-row-header {
            margin-top: 0;
            margin-bottom: 32px;
        }

        .map-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0;
            align-items: stretch;
        }

        .map-column {
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
            border-right: none;
        }
        
        .map-column:last-child {
            border-right: 1px solid var(--border);
        }

        .map-box {
            border: none;
            border-bottom: 1px solid var(--border);
            border-radius: 0;
            padding: 20px 24px;
            text-align: left;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            min-height: 100px;
            background-size: cover;
            background-position: center;
        }
        
        .map-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.65);
            pointer-events: none;
            z-index: 0;
        }
        
        .map-box .box-label,
        .map-box .box-desc {
            position: relative;
            z-index: 1;
        }
        
        /* Background images for each column */
        /* Full (100%) - Aerial standalone power generation */
        .map-column:nth-child(1) .map-box {
            background-image: url('https://cdn.prod.website-files.com/6863cc86499b79ce3ab28f8b/6874cfcad97d7a652788583a_IMG_2983__1_.webp');
        }
        
        /* Shared (30-70%) - Large construction site with crane */
        .map-column:nth-child(2) .map-box {
            background-image: url('https://cdn.prod.website-files.com/6863cc86499b79ce3ab28f8b/6874cfd06315eb43ff80d346_AbileneExpansion_800x420.webp');
        }
        
        /* Operator (0-20%) - Hyperscaler data center interior */
        .map-column:nth-child(3) .map-box {
            background-image: url('https://dgtlinfra.com/wp-content/uploads/2023/03/Hyperscale-Hyperscaler-Hyperscalers-Data-Centers-Center-Cloud-Providers-696x497.jpg');
        }

        .box-label {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.1rem;
            color: var(--accent);
            font-weight: 700;
            margin-bottom: 6px;
        }

        .box-desc {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .map-child {
            background: linear-gradient(180deg, rgba(20, 20, 20, 0.9) 0%, rgba(15, 15, 15, 0.95) 100%);
            border: none;
            border-bottom: 1px solid var(--border);
            border-radius: 0;
            padding: 12px 24px;
            text-align: left;
            transition: all 0.3s;
            position: relative;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .map-child:last-child {
            border-bottom: none;
        }

        .child-label {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.95rem;
            color: var(--text-primary);
            font-weight: 600;
            margin-bottom: 2px;
        }

        .child-desc {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.8rem;
            color: var(--text-muted);
            line-height: 1.3;
        }

        .partner-grid {
            display: flex;
            flex-direction: column;
            gap: 0;
        }
        
        .partner-grid .map-child {
            border-top: none;
        }
        
        .partner-grid .map-child:first-child {
            border-top: 1px solid var(--border);
        }
        
        .partner-row {
            align-items: stretch;
            gap: 0;
        }
        
        .partner-row > .map-child {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .intro-footer {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .intro-timing {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.9rem;
            color: var(--text-muted);
            margin: 0;
            letter-spacing: 0.05em;
        }

        .intro-cta {
            background: var(--accent);
            color: var(--bg-primary);
            border: none;
            padding: 12px 36px;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.9rem;
            font-weight: 700;
            border-radius: 0;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .intro-cta:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(200, 255, 0, 0.4);
        }

        .intro-cta span {
            transition: transform 0.3s;
            font-size: 1.5rem;
        }

        .intro-cta:hover span {
            transform: translateX(8px);
        }

        /* Wizard Container */
        .wizard-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 40px 48px;
            margin-bottom: 32px;
            display: flex;
            flex-direction: column;
            min-height: 700px;
        }

        .wizard-steps {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 32px;
            flex-shrink: 0;
        }

        .wizard-step {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-family: 'Space Mono', monospace;
            font-size: 1.05rem;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-muted);
        }

        .wizard-step:hover {
            border-color: var(--border-hover);
        }

        .wizard-step.active {
            background: var(--accent-dim);
            border-color: var(--accent);
            color: var(--accent);
        }

        .wizard-step.complete {
            background: var(--bg-card);
            border-color: var(--accent);
            color: var(--accent);
        }

        .wizard-step .step-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.05rem;
            background: var(--bg-primary);
        }

        .wizard-step.complete .step-icon {
            background: var(--accent);
            color: var(--bg-primary);
        }

        .wizard-step.active .step-icon {
            background: var(--accent);
            color: var(--bg-primary);
        }

        .wizard-content {
            max-width: 800px;
            margin: 0 auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .wizard-question {
            text-align: center;
            margin-bottom: 24px;
        }

        .wizard-question h3 {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .wizard-question p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .wizard-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex: 1;
        }

        .wizard-option {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 18px 24px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .wizard-option:hover {
            border-color: var(--border-hover);
            background: var(--bg-primary);
        }

        .wizard-option.selected {
            border-color: var(--accent);
            background: var(--accent-dim);
        }

        .wizard-option .radio-circle {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .wizard-option.selected .radio-circle {
            border-color: var(--accent);
            background: var(--accent);
        }

        .wizard-option.selected .radio-circle::after {
            content: '✓';
            color: var(--bg-primary);
            font-size: 0.85rem;
            font-weight: bold;
        }

        .wizard-option .option-content {
            flex: 1;
        }

        .wizard-option .option-label {
            font-weight: 500;
            font-size: 1rem;
            color: var(--text-primary);
            margin-bottom: 4px;
            line-height: 1.4;
        }

        .wizard-option .option-desc {
            font-size: 0.9rem;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .wizard-suboptions {
            margin-top: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 6px;
        }

        .wizard-suboption {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .wizard-suboption:hover {
            background: var(--bg-card);
            border-radius: 6px;
        }

        .wizard-suboption.radio-option {
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .wizard-suboption.radio-option.selected {
            border-color: var(--accent);
            background: var(--accent-dim);
        }

        .sub-radio {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .sub-radio.checked {
            border-color: var(--accent);
            background: var(--accent);
        }

        .sub-radio.checked::after {
            content: '✓';
            color: var(--bg-primary);
            font-size: 0.85rem;
            font-weight: bold;
        }

        .wizard-nav {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 32px;
            flex-shrink: 0;
        }

        .wizard-btn {
            padding: 14px 32px;
            border-radius: 8px;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .wizard-btn.secondary {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .wizard-btn.secondary:hover {
            border-color: var(--text-secondary);
            color: var(--text-primary);
        }

        .wizard-btn.primary {
            background: var(--accent);
            border: none;
            color: var(--bg-primary);
        }

        .wizard-btn.primary:hover {
            opacity: 0.9;
        }

        .wizard-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .wizard-restart {
            text-align: center;
            margin-top: 20px;
            flex-shrink: 0;
        }

        .restart-link {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-family: 'Space Mono', monospace;
            font-size: 1.05rem;
            cursor: pointer;
            padding: 8px 20px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .restart-link:hover {
            color: var(--accent);
            border-color: var(--accent);
            background: rgba(200, 255, 0, 0.05);
        }

        /* Results Section */
        .results-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 40px 48px;
            font-size: 1rem;
            line-height: 1.5;
        }

        .results-header h2,
        .snapshot-title,
        .gtm-title {
            font-size: 1.1rem;
        }

        .deal-type-badge {
            font-size: 1rem;
        }

        .summary-text {
            font-size: 1.15rem;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .results-header h2 {
            font-family: 'Space Mono', monospace;
            font-size: 1.2rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-primary);
        }

        .results-actions {
            display: flex;
            gap: 12px;
        }

        .action-btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-family: 'Space Mono', monospace;
            font-size: 1.05rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.2s;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .action-btn:hover {
            border-color: var(--text-secondary);
        }

        .action-btn.primary {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-primary);
        }

        .saved-scenarios-panel {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        .card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 24px;
            border: 1px solid var(--border);
        }

        .card h2 {
            font-family: 'Space Mono', monospace;
            font-size: 1.05rem;
            color: var(--text-secondary);
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 0.15em;
        }

        /* Checklist Styles */
        .checklist {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .category {
            background: var(--bg-card);
            border-radius: 6px;
            border: 1px solid var(--border);
            overflow: hidden;
            transition: border-color 0.2s;
        }

        .category:hover {
            border-color: var(--border-hover);
        }

        .category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .category-header:hover {
            background: rgba(255,255,255,0.02);
        }

        .category-header .left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .category-header .name {
            font-weight: 500;
            font-size: 1.05rem;
            color: var(--text-primary);
            letter-spacing: -0.01em;
        }

        .category-status {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.05rem;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
        }

        .category-status.yes {
            background: var(--accent-dim);
            color: var(--accent);
        }

        .category-status.partial {
            background: rgba(255, 204, 0, 0.15);
            color: var(--warning);
        }

        .category-status.no {
            background: rgba(255, 68, 68, 0.15);
            color: var(--error);
        }

        .category-toggle {
            color: var(--text-muted);
            font-size: 1.05rem;
            transition: transform 0.2s;
        }

        .category.expanded .category-toggle {
            transform: rotate(180deg);
        }

        .category-items {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: rgba(0,0,0,0.3);
        }

        .category.expanded .category-items {
            max-height: 500px;
        }

        .category-items-inner {
            padding: 12px 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .sub-item {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 6px 8px;
            border-radius: 6px;
            transition: background 0.15s;
        }

        .sub-item:hover {
            background: rgba(255,255,255,0.05);
        }

        .sub-item input[type="checkbox"] {
            display: none;
        }

        .sub-item .checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid var(--text-muted);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            flex-shrink: 0;
        }

        .sub-item input:checked + .checkbox {
            background: var(--accent);
            border-color: var(--accent);
        }

        .sub-item input:checked + .checkbox::after {
            content: "✓";
            color: var(--bg-primary);
            font-size: 1.05rem;
            font-weight: 700;
        }

        .sub-item .label {
            font-size: 1.2rem;
            color: var(--text-secondary);
        }
        
        /* Radio button styles */
        .sub-item.radio-option input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .sub-item .radio-circle {
            width: 22px;
            height: 22px;
            border: 2px solid var(--text-muted);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            flex-shrink: 0;
        }
        
        .sub-item.radio-option input[type="radio"]:checked + .radio-circle {
            background: var(--accent);
            border-color: var(--accent);
        }
        
        .sub-item.radio-option input[type="radio"]:checked + .radio-circle::after {
            content: "";
            width: 8px;
            height: 8px;
            background: var(--bg-primary);
            border-radius: 50%;
        }
        
        /* Disabled items */
        .sub-item.disabled {
            opacity: 0.35;
            pointer-events: none;
        }
        
        .sub-items-nested .sub-item {
            margin-bottom: 6px;
        }

        .sub-item.special {
            background: var(--accent-dim);
            border: 1px solid rgba(200, 255, 0, 0.2);
        }

        .sub-item select {
            font-family: 'Space Mono', monospace;
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 1.05rem;
            margin-left: auto;
        }

        /* Results Styles */
        .results {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .result-section {
            background: var(--bg-card);
            border-radius: 6px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .result-section h3 {
            font-family: 'Space Mono', monospace;
            font-size: 1.05rem;
            color: var(--text-muted);
            margin-bottom: 14px;
            text-transform: uppercase;
            letter-spacing: 0.15em;
        }

        /* Deal Type Section */
        .deal-type-name {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 12px;
            letter-spacing: -0.02em;
        }

        .deal-type-why {
            font-size: 1.35rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Partners Section */
        .partner-group {
            margin-bottom: 18px;
        }

        .partner-group:last-child {
            margin-bottom: 0;
        }

        .partner-group-title {
            font-family: 'Space Mono', monospace;
            font-size: 1.2rem;
            color: var(--accent);
            margin-bottom: 12px;
            font-weight: 400;
            letter-spacing: 0.05em;
        }

        .partner-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .partner-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 12px;
            background: rgba(255,255,255,0.02);
            border-radius: 4px;
            border: 1px solid var(--border);
        }

        .partner-item .bullet {
            color: var(--accent);
            font-weight: 700;
        }

        .partner-item .name {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 1.3rem;
        }

        .partner-item .desc {
            font-size: 1.3rem;
            color: var(--text-muted);
        }

        /* Financial Section */
        .financial-grid {
            display: grid;
            gap: 10px;
        }

        .financial-row {
            display: grid;
            grid-template-columns: 130px 1fr;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .financial-row:last-child {
            border-bottom: none;
        }

        .financial-row .label {
            font-family: 'Space Mono', monospace;
            font-size: 1.05rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .financial-row .value {
            font-size: 1.05rem;
            color: var(--text-primary);
        }

        .financial-row .value.high {
            color: var(--error);
            font-weight: 600;
        }

        .financial-row .value.medium {
            color: var(--warning);
            font-weight: 600;
        }

        .financial-row .value.low {
            color: var(--accent);
            font-weight: 600;
        }

        .tradeoff-box {
            margin-top: 16px;
            padding: 14px 16px;
            background: var(--accent-dim);
            border-left: 3px solid var(--accent);
            border-radius: 0 4px 4px 0;
        }

        .tradeoff-box .label {
            font-family: 'Space Mono', monospace;
            font-size: 1.05rem;
            color: var(--accent);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .tradeoff-box .text {
            font-size: 1.05rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Gaps Summary */
        .gaps-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .gap-tag {
            font-family: 'Space Mono', monospace;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 1.05rem;
            font-weight: 400;
            letter-spacing: 0.02em;
        }

        .gap-tag.missing {
            background: rgba(255, 68, 68, 0.12);
            color: var(--error);
            border: 1px solid rgba(255, 68, 68, 0.25);
        }

        .gap-tag.has {
            background: var(--accent-dim);
            color: var(--accent);
            border: 1px solid rgba(200, 255, 0, 0.25);
        }

        /* Reset Button */
        .reset-btn {
            font-family: 'Space Mono', monospace;
            margin-top: 20px;
            padding: 10px 20px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 1.05rem;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .reset-btn:hover {
            background: var(--bg-card);
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Print Styles */
        @media print {
            body {
                background: #fff;
                color: #000;
            }

            .card, .result-section, .category {
                background: #f9f9f9;
                border: 1px solid #ddd;
            }

            .deal-type-name {
                color: #5a7f00;
            }
        }

        /* Input Groups */
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .input-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .input-row label {
            font-family: 'Space Mono', monospace;
            font-size: 1.05rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .input-row input[type="number"],
        .input-row input[type="date"],
        .input-row select {
            font-family: 'Space Mono', monospace;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 1.05rem;
            min-width: 120px;
        }

        .input-row input:focus,
        .input-row select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .input-with-unit {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .input-with-unit input {
            width: 80px;
            text-align: right;
        }

        .input-with-unit .unit {
            font-family: 'Space Mono', monospace;
            font-size: 1.05rem;
            color: var(--text-muted);
        }

        /* Flag Items */
        .flags-group {
            gap: 10px;
        }

        .flag-item {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 8px 0;
        }

        .flag-item input {
            display: none;
        }

        .flag-check {
            width: 18px;
            height: 18px;
            border: 2px solid var(--text-muted);
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            flex-shrink: 0;
        }

        .flag-item input:checked + .flag-check {
            background: var(--warning);
            border-color: var(--warning);
        }

        .flag-item input:checked + .flag-check::after {
            content: "!";
            color: var(--bg-primary);
            font-size: 1.05rem;
            font-weight: 700;
        }

        .flag-label {
            font-size: 1.05rem;
            color: var(--text-secondary);
        }

        /* Next Steps */
        .next-steps {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .step-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 14px;
            background: var(--bg-secondary);
            border-radius: 4px;
            border-left: 3px solid var(--accent);
        }

        .step-item.risk {
            border-left-color: var(--error);
            background: rgba(255, 68, 68, 0.05);
        }

        .step-item.warning {
            border-left-color: var(--warning);
            background: rgba(255, 204, 0, 0.05);
        }

        .step-number {
            font-family: 'Space Mono', monospace;
            font-size: 1.05rem;
            color: var(--accent);
            background: var(--accent-dim);
            padding: 2px 6px;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .step-item.risk .step-number {
            color: var(--error);
            background: rgba(255, 68, 68, 0.15);
        }

        .step-item.warning .step-number {
            color: var(--warning);
            background: rgba(255, 204, 0, 0.15);
        }

        .step-text {
            font-size: 1.05rem;
            color: var(--text-primary);
            line-height: 1.4;
        }

        /* Financing Checklist */
        .financing-checklist {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .financing-section {
            background: var(--bg-secondary);
            border-radius: 4px;
            padding: 14px 16px;
            border: 1px solid var(--border);
        }

        .financing-section-title {
            font-family: 'Space Mono', monospace;
            font-size: 1.05rem;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 12px;
        }

        .financing-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .financing-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.05rem;
        }

        .financing-item .strategy-bullet {
            color: var(--accent);
            font-weight: 600;
            flex-shrink: 0;
        }

        .financing-item .item-text {
            color: var(--text-secondary);
        }

        /* Progress Bar */
        .checklist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .checklist-header h2 {
            margin-bottom: 0;
        }

        .collapse-controls {
            display: flex;
            gap: 8px;
        }

        .collapse-controls button {
            font-family: 'Space Mono', monospace;
            font-size: 1.05rem;
            padding: 4px 10px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 3px;
            color: var(--text-muted);
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .collapse-controls button:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .category.collapsed .category-items {
            display: none;
        }

        .category-header {
            cursor: pointer;
        }

        .progress-bar-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding: 10px 12px;
            background: var(--bg-card);
            border-radius: 4px;
            border: 1px solid var(--border);
        }

        .progress-bar {
            flex: 1;
            height: 6px;
            background: var(--bg-primary);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar::after {
            content: '';
            display: block;
            height: 100%;
            width: var(--progress, 0%);
            background: var(--accent);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-family: 'Space Mono', monospace;
            font-size: 1.05rem;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        /* Scenario Controls */
        .scenario-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .save-btn {
            font-family: 'Space Mono', monospace;
            padding: 10px 20px;
            background: var(--accent);
            border: none;
            border-radius: 4px;
            color: var(--bg-primary);
            font-size: 1.05rem;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 600;
        }

        .save-btn:hover {
            opacity: 0.9;
        }

        /* Saved Scenarios */
        .saved-scenarios {
            margin-top: 16px;
        }

        .saved-scenarios-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .saved-scenarios-title {
            font-family: 'Space Mono', monospace;
            font-size: 1.05rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .compare-btn {
            font-family: 'Space Mono', monospace;
            font-size: 1.05rem;
            padding: 4px 10px;
            background: transparent;
            border: 1px solid var(--accent);
            border-radius: 3px;
            color: var(--accent);
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .compare-btn:hover {
            background: var(--accent-dim);
        }

        .scenario-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .scenario-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .scenario-item:hover {
            border-color: var(--border-hover);
        }

        .scenario-item .name {
            font-size: 1.05rem;
            color: var(--text-primary);
        }

        .scenario-item .meta {
            font-family: 'Space Mono', monospace;
            font-size: 1.05rem;
            color: var(--text-muted);
        }

        .scenario-item .delete {
            font-size: 1.2rem;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0 4px;
        }

        .scenario-item .delete:hover {
            color: var(--error);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h3 {
            font-family: 'Space Mono', monospace;
            font-size: 1.05rem;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .modal-close {
            font-size: 1.8rem;
            color: var(--text-muted);
            background: none;
            border: none;
            cursor: pointer;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-selectors {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        .modal-selectors select {
            flex: 1;
            font-family: 'Space Mono', monospace;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 1.05rem;
        }

        .modal-selectors .vs {
            font-family: 'Space Mono', monospace;
            font-size: 1.05rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .comparison-table {
            padding: 20px;
        }

        .comparison-row {
            display: grid;
            grid-template-columns: 140px 1fr 1fr;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .comparison-row:last-child {
            border-bottom: none;
        }

        .comparison-row.header {
            font-family: 'Space Mono', monospace;
            font-size: 1.05rem;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .comparison-row .label {
            font-family: 'Space Mono', monospace;
            font-size: 1.05rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .comparison-row .value {
            font-size: 1.05rem;
            color: var(--text-primary);
        }

        .comparison-row .value.yes {
            color: var(--accent);
        }

        .comparison-row .value.no {
            color: var(--error);
        }

        /* Go Button */
        .go-btn {
            width: 100%;
            padding: 16px 24px;
            margin-top: 24px;
            background: var(--accent);
            border: none;
            border-radius: 6px;
            color: var(--bg-primary);
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .go-btn:hover {
            opacity: 0.9;
        }

        .go-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Input Summary */
        .input-summary {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .summary-title {
            font-family: 'Space Mono', monospace;
            font-size: 1.05rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 12px;
        }

        .summary-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .summary-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: var(--bg-secondary);
            border-radius: 4px;
            font-size: 1.05rem;
        }

        .summary-item.complete {
            color: var(--accent);
        }

        .summary-item.incomplete {
            color: var(--text-muted);
        }

        .summary-item .icon {
            font-size: 1.05rem;
        }

        /* Snapshot Card */
        .snapshot-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .snapshot-title {
            font-family: 'Space Mono', monospace;
            font-size: 1.2rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 16px;
        }

        .snapshot-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 14px;
        }

        .snapshot-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 14px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .snapshot-item.no-icon {
            gap: 0;
        }

        .snapshot-icon {
            font-size: 1.4rem;
            line-height: 1;
        }

        .snapshot-icon.yes {
            color: var(--accent);
        }

        .snapshot-icon.no {
            color: var(--error);
        }

        .snapshot-info {
            flex: 1;
        }

        .snapshot-label {
            font-size: 0.9rem;
            color: var(--text-primary);
            font-weight: 500;
            margin-bottom: 2px;
        }

        .snapshot-value {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .snapshot-status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 4px;
            font-family: 'Space Mono', monospace;
            font-size: 1.1rem;
            text-transform: uppercase;
            margin-top: 12px;
        }

        .snapshot-status.ready {
            background: var(--accent-dim);
            color: var(--accent);
        }

        .snapshot-status.not-ready {
            background: rgba(255, 68, 68, 0.15);
            color: var(--error);
        }

        /* Summary Card */
        .summary-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 32px;
        }

        .deal-output {
            display: flex;
            flex-direction: column;
            gap: 32px;
        }

        .deal-card {
            border: 1px solid var(--border);
            padding: 24px 28px;
            background: var(--bg-secondary);
            font-family: 'Space Mono', monospace;
        }

        .deal-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .deal-card-title {
            font-weight: 700;
        }

        .deal-card-meta {
            color: var(--text-muted);
        }

        .deal-card-body {
            border: 1px solid var(--border);
            padding: 18px;
            background: var(--bg-primary);
        }

        .deal-card-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .deal-card-row span:first-child {
            font-weight: 600;
            min-width: 120px;
        }

        .deal-card-row:last-child {
            margin-bottom: 0;
        }

        .strategy-matrix {
            display: grid;
            grid-template-columns: 120px repeat(3, 1fr);
            border: 1px solid var(--border);
            border-radius: 0;
            overflow: hidden;
            margin-bottom: 24px;
        }

        .strategy-matrix .matrix-head {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            border-right: 1px solid var(--border);
            padding: 16px 20px;
            font-family: 'Space Mono', monospace;
            font-size: 0.95rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
        }

        .strategy-matrix .matrix-head.empty {
            background: var(--bg-card);
        }

        .strategy-matrix .matrix-row-label {
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            padding: 20px;
            font-family: 'Space Mono', monospace;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--accent);
        }

        .strategy-matrix .matrix-cell {
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            padding: 16px;
            line-height: 1.5;
            font-size: 0.9rem;
        }

        .strategy-matrix .matrix-cell ul {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .strategy-matrix .matrix-cell li {
            position: relative;
            padding-left: 16px;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .strategy-matrix .matrix-cell li:last-child {
            margin-bottom: 0;
        }

        .strategy-matrix .matrix-cell li::before {
            content: "•";
            position: absolute;
            left: 0;
            color: var(--accent);
        }

        .strategy-matrix > div:nth-child(4n) {
            border-right: none;
        }

        .strategy-matrix > div:nth-last-child(-n+4) {
            border-bottom: none;
        }

        /* Capital Stack Diagram */
        .capital-stack-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 24px;
            margin-bottom: 24px;
        }

        .capital-stack-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .capital-stack-bar {
            display: flex;
            height: 40px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .stack-segment {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .stack-segment.debt {
            background: #3a3a3a;
            color: #ffffff;
        }

        .stack-segment.equity {
            background: var(--accent);
            color: #000000;
        }

        .stack-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .stack-label-left {
            text-align: left;
        }

        .stack-label-right {
            text-align: right;
        }

        /* Contextual Tooltips */
        .tooltip-term {
            border-bottom: 1px dotted var(--text-secondary);
            cursor: help;
            position: relative;
        }

        .tooltip-term:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #222;
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 400;
            white-space: normal;
            width: 220px;
            text-align: left;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            line-height: 1.4;
        }

        .tooltip-term:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(100%);
            border: 6px solid transparent;
            border-top-color: #222;
            z-index: 101;
        }

        .partners-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0;
            padding: 24px;
            margin-bottom: 24px;
        }

        .partners-section-title {
            font-family: 'Space Mono', monospace;
            font-size: 0.95rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .partners-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .partner-row {
            display: flex;
            align-items: baseline;
            gap: 16px;
        }

        .partner-row .partner-name {
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--accent);
            background: var(--accent-dim);
            padding: 4px 10px;
            border-radius: 4px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .partner-row .partner-desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .output-matrix {
            display: grid;
            grid-template-columns: 220px repeat(3, 1fr);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }

        .matrix-head {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            border-right: 1px solid var(--border);
            padding: 16px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .matrix-head.empty {
            background: transparent;
            border-bottom: 1px solid var(--border);
            border-right: 1px solid var(--border);
        }

        .matrix-row-label {
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            padding: 20px;
            font-weight: 600;
        }

        .matrix-cell {
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            padding: 20px;
            line-height: 1.6;
        }

        .output-matrix > div:nth-child(4n) {
            border-right: none;
        }

        .output-matrix > div:nth-last-child(-n+4) {
            border-bottom: none;
        }

        .matrix-partners {
            font-family: 'Space Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .matrix-partner-line {
            display: flex;
            gap: 10px;
        }

        .matrix-partner-name {
            font-weight: 600;
        }

        .next-steps-section {
            margin-top: 16px;
        }

        .next-steps-title {
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 12px;
        }

        .next-step-item {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .next-step-arrow {
            color: var(--accent);
            font-weight: 700;
            font-size: 1.2rem;
            line-height: 1;
        }

        .summary-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 20px;
        }

        .deal-type-badge {
            display: inline-block;
            padding: 8px 16px;
            background: var(--accent);
            color: var(--bg-primary);
            font-family: 'Space Mono', monospace;
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border-radius: 4px;
        }

        .metrics-inline {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.05rem;
            color: var(--text-secondary);
        }

        .metric-inline strong {
            color: var(--text-primary);
        }

        .metric-divider {
            color: var(--text-muted);
        }

        .summary-text {
            font-size: 1rem;
            line-height: 1.5;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .deal-summary-block {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 16px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 24px;
        }

        .deal-summary-left {
            flex: 1;
        }

        .deal-summary-right {
            flex: 1;
        }

        .mini-stack-title {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .mini-stack-bar {
            display: flex;
            height: 32px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 6px;
        }

        .mini-stack-bar .stack-segment {
            font-size: 0.75rem;
            font-weight: 600;
        }

        .mini-stack-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .summary-row {
            display: flex;
            gap: 12px;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .summary-row:last-child {
            margin-bottom: 0;
        }

        .summary-row .summary-label {
            font-family: 'Space Mono', monospace;
            font-weight: 600;
            color: var(--text-muted);
            min-width: 90px;
            flex-shrink: 0;
        }

        .summary-details {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .output-grid {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        
        .output-row {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 24px;
            align-items: start;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .output-row:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        
        .output-row.warning-row {
            border-left: none;
        }
        
        .output-row.warning-row .output-label {
            color: #f59e0b;
        }
        
        .output-row.warning-row .output-content {
            border-left: 3px solid #f59e0b;
            padding-left: 16px;
        }

        .output-label {
            font-family: 'Space Mono', monospace;
            font-size: 1rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding-top: 4px;
        }

        .output-content {
            font-size: 0.95rem;
            line-height: 1.5;
            color: var(--text-primary);
        }
        
        /* Legacy detail-section for backwards compatibility */
        .detail-section {
            display: flex;
            gap: 16px;
        }

        .detail-label {
            font-family: 'Space Mono', monospace;
            font-size: 1.1rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            min-width: 140px;
            padding-top: 2px;
        }

        .detail-content {
            flex: 1;
            font-size: 1.3rem;
            line-height: 1.5;
            color: var(--text-primary);
        }

        .output-content .partner-item,
        .detail-content .partner-item {
            display: flex;
            align-items: baseline;
            gap: 14px;
            margin-bottom: 14px;
        }
        
        .output-content .partner-item:last-child,
        .detail-content .partner-item:last-child {
            margin-bottom: 0;
        }

        .output-content .partner-tag,
        .detail-content .partner-tag {
            display: inline-block;
            padding: 6px 12px;
            background: var(--accent-dim);
            border-radius: 4px;
            font-family: 'Space Mono', monospace;
            font-size: 1.05rem;
            color: var(--accent);
            white-space: nowrap;
            flex-shrink: 0;
        }

        .output-content .partner-why,
        .detail-content .partner-why {
            font-size: 1.25rem;
            color: var(--text-muted);
        }

        .structure-main {
            font-size: 1.35rem;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .structure-detail {
            font-size: 1.3rem;
            color: var(--text-muted);
            line-height: 1.5;
        }
        
        .structure-metrics {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 16px;
            font-size: 1.2rem;
            color: var(--text-secondary);
        }
        
        .structure-metrics strong {
            color: var(--accent);
            font-family: 'Space Mono', monospace;
        }
        
        .structure-metrics .metric-dot {
            color: var(--text-muted);
            margin: 0 8px;
        }
        
        .structure-risk {
            margin-top: 12px;
            font-size: 1.2rem;
            color: var(--text-muted);
        }
        
        .structure-risk .risk-label {
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .structure-metric {
            font-family: 'Space Mono', monospace;
            font-size: 1.1rem;
            color: var(--accent);
            padding: 6px 12px;
            background: var(--accent-dim);
            border-radius: 4px;
        }

        .financial-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 16px;
        }

        .fin-metric {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .fin-label {
            font-size: 1.1rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .fin-value {
            font-family: 'Space Mono', monospace;
            font-size: 1.35rem;
            color: var(--accent);
        }

        .fin-risk {
            font-size: 1.3rem;
            color: var(--text-muted);
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .fin-risk-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* GTM Section */
        .gtm-section {
            margin-top: 32px;
            padding-top: 32px;
            border-top: 2px solid var(--border);
        }

        .gtm-title {
            font-family: 'Space Mono', monospace;
            font-size: 1.1rem;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.15em;
            margin-bottom: 24px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .gtm-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .gtm-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
        }

        .gtm-card.warning {
            border-left: 3px solid #f59e0b;
        }

        .gtm-card.highlight {
            border-left: 3px solid var(--accent);
        }

        .gtm-card-title {
            font-family: 'Space Mono', monospace;
            font-size: 1.1rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }

        .gtm-card.warning .gtm-card-title {
            color: #f59e0b;
        }

        .gtm-card.highlight .gtm-card-title {
            color: var(--accent);
        }

        .gtm-card-content {
            font-size: 1.3rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .tradeoff-section {
            margin-top: 20px;
            padding: 16px;
            background: rgba(245, 158, 11, 0.1);
            border-left: 3px solid #f59e0b;
            border-radius: 0 8px 8px 0;
        }

        .tradeoff-section .detail-label {
            color: #f59e0b;
        }

        .tradeoff-content {
            font-weight: 500;
        }

        .output-content .action-item,
        .detail-content .action-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 12px;
            font-size: 1.25rem;
            background: var(--bg-secondary);
            padding: 12px 14px;
            border-radius: 6px;
        }
        
        .output-content .action-item:last-child,
        .detail-content .action-item:last-child {
            margin-bottom: 0;
        }

        .output-content .action-item .bullet,
        .detail-content .action-item .bullet {
            color: var(--accent);
            font-size: 1.25rem;
        }

        /* Action Sections */
        .action-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .section-header {
            font-family: 'Space Mono', monospace;
            font-size: 1.05rem;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .action-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .action-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 14px;
            background: var(--bg-secondary);
            border-radius: 6px;
            font-size: 1.3rem;
            line-height: 1.4;
        }

        .action-item .bullet {
            color: var(--accent);
            font-weight: bold;
            font-size: 1.3rem;
        }

        .action-item.warning .bullet {
            color: var(--warning);
        }

        .strategy-content {
            font-size: 1.3rem;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .strategy-content .partner-tag {
            display: inline-block;
            padding: 4px 10px;
            margin: 4px 4px 4px 0;
            background: var(--accent-dim);
            border-radius: 4px;
            font-family: 'Space Mono', monospace;
            font-size: 1.05rem;
            color: var(--accent);
        }

        .strategy-content p {
            margin-bottom: 12px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .wizard-steps {
                flex-wrap: wrap;
            }
            .wizard-step span:not(.step-icon) {
                display: none;
            }
            .metrics-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon"></div>
                <h1>Crusoe</h1>
            </div>
            <p>Deal Structuring Tool</p>
        </header>

        <!-- Intro Section -->
        <div class="intro-section" id="introSection">
            <!-- Animated background elements -->
            <div class="bg-glow-bl"></div>
            <div class="bg-lines">
                <div class="bg-line"></div>
                <div class="bg-line"></div>
                <div class="bg-line"></div>
                <div class="bg-line-vertical"></div>
                <div class="bg-line-vertical"></div>
                <div class="bg-node"></div>
                <div class="bg-node"></div>
                <div class="bg-node"></div>
                <div class="bg-node"></div>
            </div>
            
            <div class="intro-content">
                <h2 class="intro-headline">Map your AI infrastructure project to the optimal capital structure.</h2>
                
                <div class="structure-map">
                    <div class="map-header">
                        <h3 class="map-title">Deal Structure</h3>
                        <p class="map-subtitle">Ownership</p>
                    </div>
                    
                    <div class="map-row ownership-row">
                        <div class="map-column">
                            <div class="map-box">
                                <div class="box-label">Full (100%)</div>
                                <div class="box-desc">Maximum control and returns</div>
                            </div>
                            <div class="map-child">
                                <div class="child-label">Self-Build</div>
                                <div class="child-desc">Project finance against contracted offtake</div>
                            </div>
                        </div>
                        <div class="map-column">
                            <div class="map-box">
                                <div class="box-label">Shared (30-70%)</div>
                                <div class="box-desc">Shared economics, reduced capital outlay</div>
                            </div>
                            <div class="map-child">
                                <div class="child-label">Capital Partner</div>
                                <div class="child-desc">Provides equity capital</div>
                            </div>
                            <div class="map-child">
                                <div class="child-label">Infra Partner</div>
                                <div class="child-desc">Contributes power or IX rights</div>
                            </div>
                            <div class="map-child">
                                <div class="child-label">Site Partner</div>
                                <div class="child-desc">Accelerates access to permitted land</div>
                            </div>
                        </div>
                        <div class="map-column">
                            <div class="map-box">
                                <div class="box-label">Operator (0-20%)</div>
                                <div class="box-desc">Fee-based returns, minimal equity</div>
                            </div>
                            <div class="map-child">
                                <div class="child-label">Hyperscaler Build</div>
                                <div class="child-desc">Customer funds capex, Crusoe operates</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="intro-footer">
                    <p class="intro-timing">5 questions. 2 minutes. Clear direction.</p>
                    <button class="intro-cta" onclick="startAssessment()">BEGIN <span>→</span></button>
                </div>
            </div>
        </div>

        <!-- Wizard -->
        <div class="wizard-container" id="wizardContainer" style="display: none;">
            <!-- Step Indicators -->
            <div class="wizard-steps" id="wizardSteps">
                <!-- Rendered by JS -->
            </div>
            
            <!-- Current Step Content -->
            <div class="wizard-content" id="wizardContent">
                <!-- Rendered by JS -->
            </div>
            
            <!-- Navigation -->
            <div class="wizard-nav">
                <button class="wizard-btn secondary" id="prevBtn" onclick="prevStep()">Back</button>
                <button class="wizard-btn primary" id="nextBtn" onclick="nextStep()">Next</button>
            </div>
            <div class="wizard-restart">
                <button class="restart-link" onclick="restartWizard()">Restart</button>
                <button class="wizard-btn primary" onclick="showResults()" style="margin-left: 16px;">See Results</button>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection" style="display: none;">
            <div class="results-header">
                <h2>Your Recommendation <span class="deal-type-badge" id="dealTypeBadgeHeader" style="margin-left: 12px; vertical-align: middle;"></span></h2>
                <div class="results-actions">
                    <button class="action-btn" onclick="resetChecklist()">Start Over</button>
                    <button class="action-btn primary" onclick="saveScenario()">Save Scenario</button>
                </div>
            </div>
            
            <!-- Results Container -->
                <div class="results-content" id="resultsContent" style="display: none;">
                    <!-- Project Snapshot -->
                    <div class="snapshot-card" id="snapshotCard">
                        <div class="snapshot-title">Project Snapshot</div>
                        <div class="snapshot-grid" id="snapshotGrid">
                            <!-- Rendered by JS -->
                        </div>
                    </div>

                    <!-- Combined Summary Card -->
                    <div class="summary-card">
                        <div class="summary-top">
                            <div class="deal-type-badge" id="dealTypeBadge">Self-Build</div>
                            <div class="metrics-inline">
                                <span class="metric-inline"><strong id="metricOwnership">100%</strong> ownership</span>
                                <span class="metric-divider">•</span>
                                <span class="metric-inline"><strong id="metricRisk">High</strong> risk</span>
                                <span class="metric-divider">•</span>
                                <span class="metric-inline"><strong id="metricReturn">High</strong> return</span>
                            </div>
                        </div>
                        <p class="summary-text" id="summaryText">
                            Complete the checklist and click Generate to see your recommendation.
                        </p>
                        <div class="summary-details" id="summaryDetails">
                            <!-- Rendered by JS -->
                        </div>
                    </div>
                </div>
            
            <!-- Saved Scenarios -->
            <div class="saved-scenarios-panel" id="savedScenarios">
                <!-- Rendered by JS -->
            </div>
        </div>
        
        <!-- Comparison Modal -->
        <div class="modal-overlay" id="compareModal" style="display: none;">
            <div class="modal">
                <div class="modal-header">
                    <h3>Compare Scenarios</h3>
                    <button class="modal-close" onclick="closeCompareModal()">×</button>
                </div>
                <div class="modal-selectors">
                    <select id="compareA" onchange="updateComparison()">
                        <option value="">Select Scenario A</option>
                    </select>
                    <span class="vs">vs</span>
                    <select id="compareB" onchange="updateComparison()">
                        <option value="">Select Scenario B</option>
                    </select>
                </div>
                <div class="comparison-table" id="comparisonTable">
                    <p style="color: var(--text-muted);">Select two scenarios to compare</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Categories and sub-items with decision-tree structure
        const categories = [
            {
                id: 'power',
                name: 'Power & Grid',
                type: 'radio',
                radioName: 'power_type',
                question: "What is your grid connection?",
                options: [
                    { 
                        id: 'power_offgrid', 
                        label: 'Off-grid / BTM',
                        subItems: []
                    },
                    { 
                        id: 'power_grid', 
                        label: 'Grid connected',
                        subItems: [
                            { id: 'ix_inqueue', label: 'Interconnection: In queue (not yet approved)', type: 'radio', radioGroup: 'ix_status' },
                            { id: 'ix_approved', label: 'Interconnection: IA approved', type: 'radio', radioGroup: 'ix_status' },
                            { id: 'ix_utility', label: 'Utility agreement signed', dependsOn: 'ix_approved' },
                            { id: 'power_longterm', label: 'Long-term power contract (5+ years)' }
                        ]
                    }
                ]
            },
            {
                id: 'site',
                name: 'Site & Land',
                type: 'radio',
                radioName: 'site_type',
                options: [
                    { 
                        id: 'site_no', 
                        label: 'No - still sourcing site',
                        subItems: []
                    },
                    { 
                        id: 'site_owned', 
                        label: 'Yes - owned or leased',
                        subItems: []
                    },
                    { 
                        id: 'site_partner_other', 
                        label: 'Yes - with another site partner',
                        subItems: []
                    }
                ]
            },
            {
                id: 'epc',
                name: 'EPC / Construction',
                type: 'radio',
                radioName: 'epc_type',
                options: [
                    { 
                        id: 'epc_selfbuild', 
                        label: 'Crusoe self-build',
                        subItems: []
                    },
                    { 
                        id: 'epc_external', 
                        label: 'External contractor',
                        subItems: []
                    }
                ]
            },
            {
                id: 'offtake',
                name: 'Offtake / Demand',
                type: 'radio',
                radioName: 'offtake_type_radio',
                options: [
                    {
                        id: 'offtake_hyperscaler',
                        label: 'Hyperscaler (Microsoft, Google, Oracle, Amazon, Meta)',
                        subItems: [
                            { id: 'offtake_hs_longterm', label: 'Long-term contract (10+ years)' }
                        ]
                    },
                    {
                        id: 'offtake_aicompany',
                        label: 'AI Company (Cursor, Together, Jua, Midjourney, etc.)',
                        subItems: [
                            { id: 'offtake_ai_funded', label: 'Well-funded (Series C+ or $500M+ raised)' },
                            { id: 'offtake_ai_longterm', label: 'Long-term contract (3+ years)' }
                        ]
                    },
                    {
                        id: 'offtake_multitenant',
                        label: 'Multiple committed tenants',
                        subItems: [
                            { id: 'offtake_mt_committed', label: '3+ customers signed' }
                        ]
                    },
                    {
                        id: 'offtake_spec',
                        label: 'Spec build / No committed offtake',
                        subItems: []
                    }
                ]
            },
            {
                id: 'capital',
                name: 'Risk Appetite',
                type: 'radio',
                radioName: 'risk_preference',
                options: [
                    { 
                        id: 'pref_maximize', 
                        label: 'Maximize ownership – take on full execution risk for higher returns',
                        subItems: []
                    },
                    { 
                        id: 'pref_share', 
                        label: 'Share risk with partner – trade some ownership for reduced exposure',
                        subItems: []
                    },
                    { 
                        id: 'pref_nopreference', 
                        label: 'No preference – optimize based on project characteristics',
                        subItems: []
                    }
                ]
            }
        ];

        // Partner database
        const partners = {
            capital: [
                { name: "Engine No.1", desc: "Activist PE, $50-200M, long-term hold, value creation focus" },
                { name: "Brookfield", desc: "Large checks $100M+, global infra platform, operational expertise" },
                { name: "Digital Bridge", desc: "Digital infrastructure focus, data center expertise" }
            ],
            site: [
                { name: "QTS", desc: "Data center sites, development expertise" },
                { name: "Lancium", desc: "Texas grid expertise, flexible sites" },
                { name: "DataBank", desc: "Land + development capabilities" }
            ],
            interconnection: [
                { name: "Oncor", desc: "Texas utility, interconnection access" },
                { name: "AEP", desc: "Multi-state utility, large capacity" },
                { name: "CenterPoint", desc: "Texas/Midwest grid access" }
            ],
            power: [
                { name: "NextEra", desc: "Renewable PPAs, large scale" },
                { name: "Invenergy", desc: "Wind/solar PPAs, flexible structures" },
                { name: "AES", desc: "Utility-scale power contracts" }
            ],
            offtake: [
                { name: "Microsoft", desc: "Hyperscaler, may finance entire project" },
                { name: "Oracle", desc: "Hyperscaler, aggressive capacity growth" },
                { name: "Anysphere (Cursor)", desc: "AI Cloud, developer tools" },
                { name: "Together AI", desc: "AI Cloud, open-source AI infrastructure" },
                { name: "Lambda", desc: "AI Cloud, ML training infrastructure" }
            ],
            debt: [
                { name: "JP Morgan", desc: "Senior debt lead arranger, large syndication" },
                { name: "MUFG", desc: "Infrastructure debt, syndicate participant" },
                { name: "Brookfield Credit", desc: "Infra-focused lending, flexible terms" }
            ],
            preferred: [
                { name: "Blue Owl", desc: "Preferred equity, flexible terms, fast close" },
                { name: "Upper 90", desc: "Growth lending, speed to close" }
            ]
        };

        // Financial implications by deal type
        const financials = {
            "Self-Build": {
                ownership: "Full (100%)",
                ownershipClass: "",
                risk: "HIGH",
                riskClass: "high",
                return: "HIGH",
                returnClass: "high",
                debtPct: 60,
                equityPct: 40,
                debtLabel: "Senior Debt",
                equityLabel: "Crusoe Equity",
                structure: "55-65% senior debt, 10-15% preferred, 25-35% equity",
                structureDetail: "Senior debt sized on DSCR (1.3-1.5x) against contracted cash flows. Preferred equity (if used) bridges gap between senior debt and common equity at 10-12% coupon. Crusoe funds 100% of common equity and retains all upside. Construction financing converts to term debt at COD.",
                irr: "18-25%",
                debtCost: "SOFR + 225-300bps",
                equityCheck: "$350-450M*",
                keyRisk: "Construction and demand risk on Crusoe balance sheet",
                howToWin: "Leverage contracted offtake to negotiate tighter spreads. Get 2-3 lenders competing. Push for longer tenor (7-10yr) to match contract length. Negotiate flex on construction timeline.",
                capitalAttraction: "Strong offtake contract is the key. Lenders want: 5+ year term, IG or near-IG credit, take-or-pay structure, clear termination provisions. Show track record of on-time, on-budget delivery.",
                watchOuts: "Construction cost overruns, interconnection delays, customer credit deterioration. Ensure EPC contract has appropriate LDs. Watch interest rate exposure pre-hedging.",
                crusoeEdge: "Vertical integration (build + operate + customer) de-risks execution. Demonstrate operational track record and customer pipeline depth to differentiate from pure developers."
            },
            "Self-Build (Spec)": {
                ownership: "Full (100%)",
                ownershipClass: "",
                risk: "VERY HIGH",
                riskClass: "high",
                return: "VERY HIGH",
                returnClass: "high",
                debtPct: 25,
                equityPct: 75,
                debtLabel: "Construction Only",
                equityLabel: "Crusoe Equity",
                structure: "40-50% equity required, limited debt without contracted revenue",
                structureDetail: "Without contracted offtake, lenders won't provide term debt. Construction financing available but requires repayment or conversion once facility is operational. Higher equity requirement reflects merchant risk. Consider LOIs or pre-leasing to unlock better financing terms.",
                irr: "25-35%+ if successful",
                debtCost: "Construction financing only, SOFR + 350-450bps",
                equityCheck: "$650-800M*",
                keyRisk: "Merchant risk - no contracted revenue, full demand exposure",
                howToWin: "De-risk with LOIs or pre-leasing commitments before breaking ground. Target 30-50% pre-leased. Build modular to scale with demand. Position in high-demand markets.",
                capitalAttraction: "Show pipeline of potential customers. Demonstrate market scarcity (limited competition, strong demand signals). Multi-tenant strategy reduces single-customer risk. Consider anchor tenant + spec space hybrid.",
                watchOuts: "Demand doesn't materialize, competitive builds in same market, technology obsolescence. Have clear pivot strategy if demand lags. Monitor competing announcements.",
                crusoeEdge: "Customer relationships and demand visibility give conviction others don't have. Operational platform means faster lease-up vs. pure developers. Can self-consume if needed."
            },
            "Capital Partnership (Spec Risk)": {
                ownership: "Shared (20-40%)",
                ownershipClass: "",
                risk: "VERY HIGH",
                riskClass: "high",
                return: "HIGH",
                returnClass: "high",
                debtPct: 20,
                equityPct: 80,
                debtLabel: "Limited Debt",
                equityLabel: "Partner + Crusoe",
                structure: "Partner takes 60-80% equity given merchant risk, limited debt",
                structureDetail: "Partner absorbs majority of merchant risk in exchange for larger equity stake and reduced promote to Crusoe. Limited debt available without contracted revenue. Crusoe contributes development expertise and operating platform. Consider multi-tenant or pre-leasing strategy to improve terms.",
                irr: "15-20% (lower promote)",
                debtCost: "Limited - construction only if any",
                equityCheck: "$50-150M*",
                keyRisk: "Finding partner comfortable with merchant exposure",
                howToWin: "Target partners with AI/data center thesis who want exposure. Family offices and growth equity more likely than traditional infra. Negotiate for higher promote once facility is leased up.",
                capitalAttraction: "Frame as 'platform bet' not single-asset risk. Show demand pipeline and Crusoe's ability to fill space. Multi-tenant reduces concentration. Partner gets exposure to AI infrastructure wave.",
                watchOuts: "Partner may want control given their risk. Negotiate operating control and customer relationship ownership. Watch for capital call timing mismatches.",
                crusoeEdge: "Crusoe's demand visibility and customer relationships are the unlock. Partner provides capital, Crusoe provides demand certainty over time."
            },
            "Capital Partnership": {
                ownership: "Shared (30-50%)",
                ownershipClass: "",
                risk: "MEDIUM",
                riskClass: "medium",
                return: "MEDIUM",
                returnClass: "medium",
                debtPct: 55,
                equityPct: 45,
                debtLabel: "Project Debt",
                equityLabel: "Partner + Crusoe",
                structure: "Partner takes 50-70% equity, project debt 50-60% of total",
                structureDetail: "Typical JV structure with institutional capital partner (infra fund, PE, family office). Partner provides majority of equity, Crusoe contributes development, offtake, and operations. Project-level debt sized on contracted cash flows. Crusoe earns dev fee at closing, operating fees ongoing, and promote (carried interest) on outperformance above hurdle rate.",
                irr: "15-22% on Crusoe equity",
                debtCost: "SOFR + 200-275bps (partner credit helps)",
                equityCheck: "$100-200M*",
                keyRisk: "Alignment with partner on operations and exits",
                howToWin: "Run competitive process with 3-5 capital partners. Negotiate: (1) higher promote (20%+ above 8% hurdle), (2) operating control, (3) customer relationship ownership, (4) ROFR on future deals.",
                capitalAttraction: "Contracted offtake de-risks for partner. Crusoe's track record reduces execution risk. Clear path to stabilized cash flows. Potential for portfolio deal if successful.",
                watchOuts: "Partner alignment on hold period and exit timing. Operating vs. strategic decisions. Cost overrun responsibility. Customer relationship ownership post-exit.",
                crusoeEdge: "Crusoe is the scarce asset - development capability, customer relationships, operational platform. Capital is abundant. Price accordingly."
            },
            "Infra Partnership": {
                ownership: "Shared (varies)",
                ownershipClass: "",
                risk: "MEDIUM",
                riskClass: "medium",
                return: "MEDIUM",
                returnClass: "medium",
                debtPct: 55,
                equityPct: 45,
                debtLabel: "Project Debt",
                equityLabel: "JV Equity",
                structure: "Partner contributes assets, Crusoe contributes offtake/ops",
                structureDetail: "Partner brings existing infrastructure (power, land, interconnection rights) and Crusoe brings demand and operational expertise. Equity split reflects relative value of contributions. May include lease structures, revenue shares, or traditional JV equity. Debt capacity depends on asset quality and contract structure.",
                irr: "12-18% on contributed capital",
                debtCost: "Depends on asset quality",
                equityCheck: "Varies - may be asset contribution*",
                keyRisk: "Partner asset quality and operational alignment",
                howToWin: "Value the asset contribution fairly - don't overpay for stranded assets. Negotiate operating control and ability to bring your own customers. Push for exclusivity in geography/market.",
                capitalAttraction: "Partner's existing assets reduce development risk and timeline. Pre-permitted, interconnected sites are valuable. Show how Crusoe monetizes underutilized infrastructure.",
                watchOuts: "Asset quality issues (deferred maintenance, capacity constraints). Partner's other priorities conflicting. Exit rights if partnership doesn't work. Technology compatibility.",
                crusoeEdge: "Crusoe can monetize assets others can't. Power + land without demand is stranded. Crusoe brings the demand that makes the asset valuable."
            },
            "Site Partnership": {
                ownership: "Shared (varies)",
                ownershipClass: "",
                risk: "MEDIUM",
                riskClass: "medium",
                return: "MEDIUM",
                returnClass: "medium",
                debtPct: 55,
                equityPct: 45,
                debtLabel: "Project Debt",
                equityLabel: "Site + Crusoe",
                structure: "Partner contributes site, Crusoe brings offtake and operations",
                structureDetail: "Land/site owner contributes real estate and potentially power/IX rights. Crusoe brings demand and operations. Structure can be ground lease (Crusoe pays rent), JV (shared ownership), or build-to-suit (partner builds, Crusoe leases). Negotiate based on scarcity of site vs. scarcity of demand in the market.",
                irr: "12-18% on Crusoe contribution",
                debtCost: "Varies by partner credit",
                equityCheck: "Based on contribution split*",
                keyRisk: "Site quality and partner reliability",
                howToWin: "Understand partner's motivation - are they optimizing for yield, strategic value, or exit? Structure accordingly. Negotiate expansion rights and exclusivity. Push for operating control.",
                capitalAttraction: "Site de-risks timeline and permitting. Partner may bring their own capital or credit. Clear asset = clear financing path. Show how demand transforms a land asset into cash-flowing infrastructure.",
                watchOuts: "Site due diligence - zoning, environmental, title. Partner reliability and financial stability. Competing uses for the site. Termination and buyout provisions.",
                crusoeEdge: "Crusoe turns real estate into infrastructure yield. Land owners can't do this alone. Position as the partner that maximizes their asset's value."
            },
            "Site JV": {
                ownership: "JV (40-60%)",
                ownershipClass: "",
                risk: "MEDIUM",
                riskClass: "medium",
                return: "MEDIUM-HIGH",
                returnClass: "medium",
                debtPct: 50,
                equityPct: 50,
                debtLabel: "JV Debt",
                equityLabel: "JV Equity",
                structure: "Joint venture SPV with site partner, shared capital contributions",
                structureDetail: "Form JV entity with site owner. Partner contributes land/site, Crusoe contributes demand, development expertise, and operations. Equity split (40-60%) reflects relative value. JV can access project debt. Crusoe earns operating fees and share of upside. Pre-set buyout formulas for exit flexibility.",
                irr: "15-20% on Crusoe equity",
                debtCost: "SOFR + 225-300bps (JV credit)",
                equityCheck: "$150-300M*",
                keyRisk: "JV governance and alignment on expansion",
                howToWin: "Align on capital contribution rules and dilution mechanics. Crusoe must lead build and operations. Pre-set buyout formulas to avoid disputes. Lock in Phase 2/3 expansion rights.",
                capitalAttraction: "JV structure shares risk while preserving upside. Site partner brings land value, Crusoe brings demand certainty. Combined credit may improve debt terms.",
                watchOuts: "Governance deadlocks on major decisions. Capital call friction if expansion needed. Exit timing misalignment. Conflicts over land value appreciation vs. infrastructure value.",
                crusoeEdge: "Crusoe's demand and operational expertise transforms land into yielding infrastructure. JV lets site owner participate in upside they couldn't capture alone."
            },
            "Infra JV": {
                ownership: "JV (40-60%)",
                ownershipClass: "",
                risk: "MEDIUM",
                riskClass: "medium",
                return: "MEDIUM-HIGH",
                returnClass: "medium",
                debtPct: 55,
                equityPct: 45,
                debtLabel: "JV Debt",
                equityLabel: "JV Equity",
                structure: "Joint venture SPV with infrastructure partner, shared ownership",
                structureDetail: "Form JV entity with power/IX partner. Partner contributes existing infrastructure assets (power, interconnection, permits), Crusoe contributes demand and operations. Equity split reflects asset valuations. JV accesses project debt against contracted cash flows. Clear roles for upgrades and maintenance.",
                irr: "15-20% on Crusoe equity",
                debtCost: "SOFR + 200-275bps (asset-backed)",
                equityCheck: "$100-250M*",
                keyRisk: "Asset valuation and regulatory constraints",
                howToWin: "Fair valuation of contributed infrastructure - don't overpay for stranded assets. Crusoe must hold operating control and customer ownership. Define clear upgrade/maintenance responsibilities. Commit roadmap for capacity additions.",
                capitalAttraction: "Partner's existing assets accelerate deployment. JV structure lets infra owner participate in compute-driven upside. Combined platform enables multi-phase growth.",
                watchOuts: "Asset valuation disputes at formation. Regulatory/utility constraints on power use. Technology evolution (density, cooling requirements). Exit mechanics if partnership underperforms.",
                crusoeEdge: "Crusoe turns underutilized power/IX into compute revenue. Infra partners need demand to monetize assets. Position as the operator and customer engine that unlocks value."
            },
            "Hyperscaler-Backed": {
                ownership: "Minority (0-20%)",
                ownershipClass: "",
                risk: "LOW",
                riskClass: "low",
                return: "LOW",
                returnClass: "low",
                debtPct: 70,
                equityPct: 30,
                debtLabel: "Hyperscaler Credit",
                equityLabel: "Hyperscaler",
                structure: "Hyperscaler funds most/all capex. Fee-based or capped equity return.",
                structureDetail: "Hyperscaler (Microsoft, Google, Oracle, etc.) funds 80-100% of capex using their balance sheet. Crusoe operates facility for fixed fees or small equity stake with capped returns. No project debt needed - hyperscaler credit backstops everything. Trade-off: de-risked and fast, but limited enterprise value creation. Best for volume/scale plays.",
                irr: "8-12% (fee-based)",
                debtCost: "N/A - hyperscaler balance sheet",
                equityCheck: "$0-60M*",
                keyRisk: "Customer concentration, limited value capture",
                howToWin: "Compete on speed and execution, not price. Hyperscalers value reliability and relationship. Negotiate: (1) escalators tied to inflation, (2) expansion rights, (3) other site opportunities. Build relationship for future deals.",
                capitalAttraction: "Hyperscaler credit eliminates financing risk. Focus on operational excellence to win repeat business. Use this as proof point for other capital partners on future deals.",
                watchOuts: "Single customer concentration. Fee compression over time. Hyperscaler may in-source long-term. Limited enterprise value creation - you're a vendor, not an owner.",
                crusoeEdge: "Speed and flexibility vs. traditional data center developers. Operational expertise in AI/HPC workloads. Relationship depth with hyperscaler procurement teams."
            },
            "Find Offtake First": {
                ownership: "TBD",
                ownershipClass: "",
                risk: "HIGH",
                riskClass: "high",
                return: "TBD",
                returnClass: "",
                debtPct: 0,
                equityPct: 100,
                debtLabel: "No Debt",
                equityLabel: "TBD",
                structure: "Cannot finalize structure without demand visibility",
                structureDetail: "Capital structure depends entirely on offtake quality. Hyperscaler offtake enables 60-70% debt. AI cloud or enterprise customer enables 50-60% debt with strong credit. Merchant/spec requires mostly equity. Focus BD efforts on securing demand - this is the critical unlock for all financing options.",
                irr: "TBD - depends on customer",
                debtCost: "Not financeable without offtake",
                equityCheck: "TBD*",
                keyRisk: "No committed demand = no financing path",
                howToWin: "Prioritize BD resources on this opportunity. Target: hyperscalers (best terms), AI cloud providers (CoreWeave, Lambda), enterprises with AI initiatives. Get LOI or term sheet before spending more on site development.",
                capitalAttraction: "Nothing to pitch until demand is secured. Use site optionality as selling point to customers ('we can deliver faster'). Once LOI in hand, capital options open up significantly.",
                watchOuts: "Don't over-invest in site development without demand visibility. Opportunity cost of capital and team time. Competitive dynamics - others may secure the customer first.",
                crusoeEdge: "Crusoe's existing customer relationships and reputation. Operational track record. Speed to deployment. Use these to win the customer, then the financing follows."
            },
            "Pipeline Development": {
                ownership: "N/A",
                ownershipClass: "",
                risk: "N/A",
                riskClass: "",
                return: "N/A",
                returnClass: "",
                debtPct: 0,
                equityPct: 0,
                debtLabel: "",
                equityLabel: "",
                structure: "Pre-deal stage - focus on sourcing",
                structureDetail: "Too early to discuss capital structure. Focus on advancing pipeline: secure site control, file interconnection application, or develop customer relationships. Once you have 2+ of these elements, return to evaluate deal structure options.",
                irr: "N/A",
                debtCost: "N/A",
                equityCheck: "N/A",
                keyRisk: "Need to advance pipeline before financing",
                howToWin: "Parallel path: (1) source sites with power/IX potential, (2) build customer pipeline, (3) develop partner relationships. Whichever unlocks first determines deal structure.",
                capitalAttraction: "Too early for capital conversations. Focus on creating optionality. Once you have site + demand or site + partner, return for financing strategy.",
                watchOuts: "Analysis paralysis - don't wait for perfect. Move fast on promising opportunities. Competitive dynamics - good sites and customers get taken.",
                crusoeEdge: "Crusoe's platform and relationships create deal flow others don't see. Use existing customer conversations to identify site needs. Use site pipeline to attract customers."
            }
        };

        // Tooltip definitions for finance terms
        const tooltipTerms = {
            'DSCR': 'Debt Service Coverage Ratio - cash flow available to pay debt obligations. Lenders typically require 1.3-1.5x minimum.',
            'IG': 'Investment Grade - credit rating of BBB- or higher. Unlocks better debt terms and higher leverage.',
            'SOFR': 'Secured Overnight Financing Rate - the benchmark rate for floating-rate debt pricing.',
            'promote': 'Carried interest - additional equity share earned for returns above a hurdle rate (typically 8-12%).',
            'ROFR': 'Right of First Refusal - contractual option to match competing offers on future deals.',
            'IRR': 'Internal Rate of Return - annualized return on invested capital.'
        };

        // Helper to wrap terms with tooltips
        function addTooltips(text) {
            let result = text;
            // Match whole words/acronyms and common compound forms
            result = result.replace(/\bDSCR\b/g, '<span class="tooltip-term" data-tooltip="' + tooltipTerms['DSCR'] + '">DSCR</span>');
            result = result.replace(/\b(near-)?IG\b/g, function(match) {
                return '<span class="tooltip-term" data-tooltip="' + tooltipTerms['IG'] + '">' + match + '</span>';
            });
            result = result.replace(/\bSOFR\b/g, '<span class="tooltip-term" data-tooltip="' + tooltipTerms['SOFR'] + '">SOFR</span>');
            result = result.replace(/\bpromotes?\b/gi, function(match) {
                return '<span class="tooltip-term" data-tooltip="' + tooltipTerms['promote'] + '">' + match + '</span>';
            });
            result = result.replace(/\bROFR\b/g, '<span class="tooltip-term" data-tooltip="' + tooltipTerms['ROFR'] + '">ROFR</span>');
            result = result.replace(/\bIRR\b/g, '<span class="tooltip-term" data-tooltip="' + tooltipTerms['IRR'] + '">IRR</span>');
            return result;
        }

        // Matrix row content (Crusoe-specific)
        const matrixRows = {
            Debt: {
                want: [
                    "Investment grade or near-IG offtaker",
                    "1.3-1.5x DSCR on base case",
                    "Predictable timeline and cash flows",
                    "Crusoe operational track record"
                ],
                win: [
                    "Run competitive process with 2-3 lead arrangers",
                    "Push for 7-10 year tenor to match contract",
                    "Negotiate construction timeline flex",
                    "Show pipeline depth for repeat business"
                ],
                risks: [
                    "Interest rate exposure pre-hedging",
                    "Customer credit deterioration",
                    "Refinancing risk if short tenor",
                    "Construction cost overruns"
                ]
            },
            Equity: {
                want: [
                    "5+ year contracted revenue",
                    "15%+ net IRR, clear exit path",
                    "Crusoe co-investment (skin in game)",
                    "Platform potential, not one-off"
                ],
                win: [
                    "Structure promotes that reward outperformance",
                    "Demonstrate pipeline depth for follow-on deals",
                    "Clear governance with aligned incentives and oversight",
                    "Run competitive process with 3+ partners"
                ],
                risks: [
                    "Misalignment on hold period/exit timing",
                    "Governance on major decisions",
                    "Sponsor credit and balance sheet strength",
                    "Demand risk if contract is short"
                ]
            },
            Partner: {
                want: [
                    "15%+ net IRR, clear exit path",
                    "Contracted cash flows, de-risked execution",
                    "Co-invest from Crusoe (skin in game)",
                    "Platform potential, not one-off"
                ],
                win: [
                    "Run competitive process with 3+ partners",
                    "Retain operating control and customer ownership",
                    "Structure promotes that reward outperformance (20%+ above hurdle)",
                    "Demonstrate pipeline depth - position as platform, not one-off"
                ],
                risks: [
                    "Misalignment on hold period",
                    "Governance on major decisions",
                    "Exit timing conflicts",
                    "Transfer pricing disputes"
                ]
            },
            CapitalPartner: {
                want: [
                    "12-15%+ IRR, clear exit",
                    "Long-term contracted cash flows",
                    "Sponsor co-invest",
                    "Repeatable platform"
                ],
                win: [
                    "Competitive process for market terms",
                    "Aligned promote/hurdles",
                    "Strong operator story (Crusoe control)",
                    "Visible multi-phase pipeline"
                ],
                risks: [
                    "Exit/hold misalignment",
                    "Governance disputes",
                    "Cost overrun allocation",
                    "Operator performance / step-in rights"
                ]
            },
            InfraPartner: {
                want: [
                    "Monetize underused power/IX",
                    "Demand certainty",
                    "Stable long-term revenue",
                    "Experienced operator"
                ],
                win: [
                    "Don't overpay for aging assets",
                    "Secure operating + customer rights",
                    "JV/lease tied to asset condition/credit",
                    "Option to bring additional customers"
                ],
                risks: [
                    "Asset quality / deferred maintenance",
                    "Regulatory constraints",
                    "Tech compatibility limits",
                    "Exit/unwind provisions"
                ]
            },
            SitePartner: {
                want: [
                    "Maximize land value",
                    "Reliable, creditworthy tenant",
                    "Low development/operational risk",
                    "Expansion optionality"
                ],
                win: [
                    "Align economics to motivation",
                    "Expansion rights + Crusoe-only ROFR",
                    "Crusoe-led operations for execution certainty",
                    "Structure based on site + permitting constraints"
                ],
                risks: [
                    "Zoning/environmental/title issues",
                    "Interconnection uncertainty",
                    "Partner reliability / capital limits",
                    "Termination or buyout mechanics"
                ]
            },
            SiteJVPartner: {
                want: [
                    "Equity upside from Crusoe demand",
                    "Reliable builder-operator",
                    "Clean governance",
                    "Expansion tied to Crusoe growth"
                ],
                win: [
                    "Align capital + dilution rules",
                    "Crusoe leads build + ops",
                    "Pre-set buyout formulas",
                    "Lock long-term site + Phase 2/3 rights"
                ],
                risks: [
                    "Governance deadlocks",
                    "Capital call friction",
                    "Exit timing mismatch",
                    "Conflicts over land value / expansion"
                ]
            },
            InfraJVPartner: {
                want: [
                    "Upside from compute-driven load",
                    "Monetize underused power/IX",
                    "Crusoe as operator + customer engine",
                    "Scalable multi-phase platform"
                ],
                win: [
                    "Fair valuation of contributed infra",
                    "Crusoe holds ops + customer ownership",
                    "Clear upgrade/maintenance roles",
                    "Commit roadmap for added MW"
                ],
                risks: [
                    "Asset valuation disputes",
                    "Regulatory/utility constraints",
                    "Tech evolution (density, cooling)"
                ]
            },
            Customer: {
                want: [
                    "Capacity available NOW",
                    "Reliability, proven uptime",
                    "Competitive $/kW pricing",
                    "Long-term partnership potential"
                ],
                win: [
                    "Lead with Crusoe's speed advantage vs. traditional DC",
                    "Show GPU/AI workload operational expertise",
                    "Offer flexibility others can't (modular, scalable)",
                    "Reference existing customer relationships"
                ],
                risks: [
                    "Single customer concentration",
                    "Fee compression over time",
                    "Customer may in-source long-term",
                    "Demand doesn't materialize (spec)"
                ]
            },
            Execution: {
                want: [
                    "Clear scope and specifications",
                    "Realistic timeline with buffer",
                    "Payment milestones tied to progress",
                    "Change order process defined"
                ],
                win: [
                    "Leverage Crusoe self-build capability",
                    "Negotiate appropriate LDs in EPC contract",
                    "Parallel path long-lead equipment",
                    "Maintain 10-15% contingency"
                ],
                risks: [
                    "Construction delays",
                    "Supply chain disruptions",
                    "Interconnection timeline slippage",
                    "Permitting surprises"
                ]
            },
            Sourcing: {
                want: [
                    "Credible development partner",
                    "Ability to execute and close",
                    "Clear decision-making process"
                ],
                win: [
                    "Parallel path: sites + customers + capital",
                    "Use existing relationships for deal flow",
                    "Move fast on promising opportunities"
                ],
                risks: [
                    "Opportunity cost of time/capital",
                    "Competitive dynamics",
                    "Analysis paralysis"
                ]
            }
        };

        // Deal type configuration (rows + partners)
        const dealTypeConfig = {
            "Self-Build": {
                rows: [
                    { type: "Debt", label: "Debt" },
                    { type: "Equity", label: "Equity" }
                ],
                partners: [
                    { name: "JP Morgan", desc: "Senior debt lead arranger - $500M+ capacity, AI/data center experience" },
                    { name: "MUFG", desc: "Infrastructure debt syndicate - strong in project finance, co-lead" },
                    { name: "Brookfield Credit", desc: "Infra-focused lending - flexible on structure, faster process" },
                    { name: "Blue Owl", desc: "Preferred equity if needed - 10-12% coupon, bridge to permanent" }
                ]
            },
            "Self-Build (Spec)": {
                rows: [
                    { type: "Customer", label: "Customer" },
                    { type: "Equity", label: "Equity" }
                ],
                partners: [
                    { name: "Microsoft/Oracle", desc: "Hyperscalers - best financing terms, IG credit unlocks 65%+ debt" },
                    { name: "Lambda Labs", desc: "ML training infra - well-funded, capacity constrained, quick decisions" },
                    { name: "Together AI", desc: "Open-source AI - $100M+ raised, growing compute needs" }
                ]
            },
            "Capital Partnership": {
                rows: [
                    { type: "CapitalPartner", label: "Capital Partner" },
                    { type: "Debt", label: "Debt" }
                ],
                partners: [
                    { name: "Engine No. 1", desc: "Activist PE - $50-200M checks, long hold, value creation focus" },
                    { name: "Brookfield", desc: "Global infra platform - $100M+ checks, operational expertise, repeat partner potential" },
                    { name: "DigitalBridge", desc: "Digital infrastructure specialist - data center expertise, strategic value-add" },
                    { name: "KKR Infra", desc: "Large scale - $200M+ capacity, platform investment appetite" }
                ]
            },
            "Capital Partnership (Spec Risk)": {
                rows: [
                    { type: "Customer", label: "Customer" },
                    { type: "CapitalPartner", label: "Capital Partner" }
                ],
                partners: [
                    { name: "Microsoft/Oracle", desc: "Hyperscalers - anchor customer unlocks partner interest" },
                    { name: "Engine No. 1", desc: "Activist PE - may take spec risk with strong demand signals" },
                    { name: "DigitalBridge", desc: "Digital infra - understands data center demand dynamics" }
                ]
            },
            "Infra Partnership": {
                rows: [
                    { type: "InfraPartner", label: "Infra Partner" },
                    { type: "Execution", label: "Execution" }
                ],
                partners: [
                    { name: "Lancium", desc: "Texas grid expertise - flexible load sites, power procurement capability" },
                    { name: "QTS", desc: "Data center developer - land bank, development expertise, potential JV" },
                    { name: "DataBank", desc: "Regional DC platform - site + power packages, partnership appetite" },
                    { name: "Compass", desc: "Large scale campus developer - hyperscale experience, capital access" }
                ]
            },
            "Site Partnership": {
                rows: [
                    { type: "SitePartner", label: "Site Partner" },
                    { type: "Execution", label: "Execution" }
                ],
                partners: [
                    { name: "QTS", desc: "Data center developer - land positions, development expertise" },
                    { name: "DataBank", desc: "Regional platform - site + power packages available" },
                    { name: "JP Morgan", desc: "Project debt - finance against site + offtake" },
                    { name: "MUFG", desc: "Infrastructure lending - syndicate participant" }
                ]
            },
            "Site JV": {
                rows: [
                    { type: "SiteJVPartner", label: "Site JV Partner" },
                    { type: "Execution", label: "Execution" }
                ],
                partners: [
                    { name: "QTS", desc: "Data center developer - land bank, JV experience, capital access" },
                    { name: "DataBank", desc: "Regional platform - site + power packages, JV appetite" },
                    { name: "Prologis", desc: "Industrial REIT - land positions, long-term hold, data center pivot" },
                    { name: "JP Morgan", desc: "JV-level debt - finance against combined credit" }
                ]
            },
            "Infra JV": {
                rows: [
                    { type: "InfraJVPartner", label: "Infra JV Partner" },
                    { type: "Execution", label: "Execution" }
                ],
                partners: [
                    { name: "Lancium", desc: "Texas grid expertise - flexible load, power procurement, JV track record" },
                    { name: "QTS", desc: "Data center developer - land + power packages, JV structure experience" },
                    { name: "Compass", desc: "Large scale campus developer - hyperscale experience, capital access" },
                    { name: "JP Morgan", desc: "JV-level debt - finance against asset base + contracted revenue" }
                ]
            },
            "Hyperscaler-Backed": {
                rows: [
                    { type: "Customer", label: "Hyperscaler" },
                    { type: "Execution", label: "Execution" }
                ],
                partners: [
                    { name: "Microsoft", desc: "Azure expansion - aggressive capacity targets, may fund entire build" },
                    { name: "Oracle", desc: "OCI growth - fast moving, flexible on structure, existing Crusoe relationship" },
                    { name: "Google", desc: "GCP capacity - longer process but large scale potential" },
                    { name: "Meta", desc: "AI infrastructure buildout - significant near-term demand" }
                ]
            },
            "Find Offtake First": {
                rows: [
                    { type: "Customer", label: "Target Customer" }
                ],
                partners: [
                    { name: "Microsoft/Oracle", desc: "Hyperscalers - best financing terms, IG credit unlocks 65%+ debt" },
                    { name: "CoreWeave", desc: "AI cloud - GPU-focused, fast growth, strong funding, potential anchor" },
                    { name: "Lambda Labs", desc: "ML training infra - well-funded, capacity constrained, quick decisions" },
                    { name: "Together AI", desc: "Open-source AI - $100M+ raised, growing compute needs" },
                    { name: "Anyscale", desc: "Ray/AI infrastructure - enterprise customers, scaling needs" }
                ]
            },
            "Pipeline Development": {
                rows: [
                    { type: "Sourcing", label: "Sourcing" }
                ],
                partners: [
                    { name: "Oncor/AEP", desc: "Utilities - interconnection pipeline, grid access opportunities" },
                    { name: "Lancium/QTS", desc: "Site developers - land positions, development partnerships" },
                    { name: "Microsoft/Oracle", desc: "Demand-led - customer relationships drive site selection" }
                ]
            }
        };

        // State
        let state = {};

        // Initialize state
        function initState() {
            categories.forEach(cat => {
                if (cat.type === 'radio') {
                    // Initialize radio options and their sub-items
                    cat.options.forEach(opt => {
                        state[opt.id] = false;
                        opt.subItems.forEach(sub => {
                            if (sub.type === 'select') {
                                state[sub.id] = sub.options[0];
                            } else {
                                state[sub.id] = false;
                            }
                        });
                    });
                } else if (cat.type === 'conditional') {
                    // Initialize parent and sub-items
                    state[cat.parentItem.id] = false;
                    cat.subItems.forEach(sub => {
                        if (sub.type === 'select') {
                            state[sub.id] = sub.options[0];
                        } else {
                            state[sub.id] = false;
                        }
                    });
                } else if (cat.type === 'simple') {
                    // Initialize simple items
                    cat.items.forEach(item => {
                        if (item.type === 'select') {
                            state[item.id] = item.options[0];
                        } else {
                            state[item.id] = false;
                        }
                    });
                }
            });
            loadState();
        }

        // Load from localStorage
        function loadState() {
            const saved = localStorage.getItem('crusoe_readiness_v3');
            if (saved) {
                state = { ...state, ...JSON.parse(saved) };
            }
        }

        // Save to localStorage
        function saveState() {
            localStorage.setItem('crusoe_readiness_v3', JSON.stringify(state));
        }

        // Get category status
        function getCategoryStatus(cat) {
            if (cat.type === 'radio') {
                // Check if any radio option is selected
                const selectedOption = cat.options.find(opt => state[opt.id]);
                if (!selectedOption) return 'no';
                
                // Check if sub-items are complete
                const subItems = selectedOption.subItems.filter(i => i.type !== 'select');
                if (subItems.length === 0) return 'yes'; // No sub-items needed
                
                const checked = subItems.filter(i => state[i.id] === true).length;
                if (checked === subItems.length) return 'yes';
                return 'partial';
            }
            
            if (cat.type === 'conditional') {
                // Check if parent is checked
                if (!state[cat.parentItem.id]) return 'no';
                
                // Check sub-items
                const subItems = cat.subItems.filter(i => i.type !== 'select');
                const checked = subItems.filter(i => state[i.id] === true).length;
                if (checked === subItems.length) return 'yes';
                return 'partial';
            }
            
            if (cat.type === 'simple') {
                const items = cat.items.filter(i => i.type !== 'select');
                const checked = items.filter(i => state[i.id] === true).length;
                if (checked === 0) return 'no';
                if (checked === items.length) return 'yes';
                return 'partial';
            }
            
            return 'no';
        }

        // Check if category has critical items
        function hasCategoryCore(catId) {
            if (catId === 'power') {
                // Off-grid is complete, or grid with IX status selected
                if (state['power_offgrid']) return true;
                if (state['power_grid']) {
                    // Grid requires IX status to be selected
                    return state['ix_inqueue'] || state['ix_approved'];
                }
                return false;
            }
            if (catId === 'site') {
                return state['site_owned'] || state['site_partner_other'];
            }
            if (catId === 'epc') {
                // Self-build OR external contractor path
                return state['epc_selfbuild'] || state['epc_external'];
            }
            if (catId === 'offtake') {
                // Any offtake strategy selected
                return state['offtake_hyperscaler'] || state['offtake_aicompany'] || state['offtake_multitenant'] || state['offtake_spec'];
            }
            if (catId === 'capital') {
                return state['pref_maximize'] || state['pref_share'] || state['pref_nopreference'];
            }
            return false;
        }

        // Determine deal type
        function determineDealType() {
            const hasPower = hasCategoryCore('power');
            const hasSite = hasCategoryCore('site');
            const hasOfftake = hasCategoryCore('offtake');
            const hasRiskPref = hasCategoryCore('capital');
            
            // Power & Grid status (merged - hasPower includes IX status for grid)
            // For grid projects, hasPower = true means IX status is also selected
            const isOffgrid = state['power_offgrid'];
            const isGridConnected = state['power_grid'];
            const hasIxApproved = state['ix_approved'];
            
            // Check for site partner
            const hasSitePartner = state['site_partner_other'];
            
            // Determine offtake type
            const isHyperscaler = state['offtake_hyperscaler'];
            const isAICompany = state['offtake_aicompany'];
            const isMultitenant = state['offtake_multitenant'];
            const isSpec = state['offtake_spec'];
            
            // Check offtake quality
            const hasHsLongterm = state['offtake_hs_longterm'];
            const hasAiFunded = state['offtake_ai_funded'];
            const hasAiLongterm = state['offtake_ai_longterm'];
            const hasMtCommitted = state['offtake_mt_committed'];
            
            // Strong anchor = hyperscaler OR well-funded AI company with long-term contract
            const hasStrongAnchor = isHyperscaler || (isAICompany && hasAiFunded && hasAiLongterm);
            const hasAnchor = isHyperscaler || isAICompany;
            
            // Risk appetite preferences
            const prefersMaxOwnership = state['pref_maximize'];
            const prefersSharing = state['pref_share'];

            // Site Partnership/JV - partner contributing site
            if (hasSitePartner && hasOfftake) {
                if (prefersSharing) return "Site JV";
                return "Site Partnership";
            }

            // Spec build - high risk
            if (isSpec && hasPower && hasSite) {
                if (prefersMaxOwnership) return "Self-Build (Spec)";
                return "Capital Partnership (Spec Risk)";
            }

            // Multi-tenant with committed customers - moderate risk
            if (isMultitenant && hasPower && hasSite) {
                if (hasMtCommitted) {
                    if (prefersMaxOwnership) return "Self-Build";
                    return "Capital Partnership";
                }
                // Multi-tenant without commitments = spec risk
                if (prefersMaxOwnership) return "Self-Build (Spec)";
                return "Capital Partnership (Spec Risk)";
            }
            
            // AI Company without strong profile - partnership recommended regardless of preference
            if (isAICompany && hasPower && hasSite && (!hasAiFunded || !hasAiLongterm)) {
                if (prefersMaxOwnership) return "Self-Build"; // Allow but flag risk in output
                return "Capital Partnership";
            }

            // All key elements with anchor
            if (hasPower && hasSite && hasAnchor) {
                if (prefersMaxOwnership) return "Self-Build";
                return "Capital Partnership";
            }

            // Has power + site, no offtake
            if (hasPower && hasSite && !hasOfftake) {
                return "Find Offtake First";
            }

            // Has power, missing site, has offtake
            if (hasPower && !hasSite && hasOfftake) {
                if (isHyperscaler) return "Hyperscaler-Backed";
                if (prefersSharing) return "Infra JV";
                return "Infra Partnership";
            }

            // Has power, missing site, but has anchor offtake
            if (hasPower && !hasSite && hasAnchor) {
                if (isHyperscaler) {
                    return "Hyperscaler-Backed";
                }
                if (prefersSharing) return "Infra JV";
                return "Infra Partnership";
            }

            // Missing power but has hyperscaler anchor (they may bring power)
            if (!hasPower && hasAnchor && isHyperscaler) {
                return "Hyperscaler-Backed";
            }
            
            // Hyperscaler with all elements
            if (isHyperscaler && hasOfftake) {
                if (prefersSharing) return "Hyperscaler-Backed";
                return "Self-Build";
            }

            // Has site, missing power, no offtake
            if (hasSite && !hasPower && !hasOfftake) {
                if (prefersSharing) return "Infra JV";
                return "Infra Partnership";
            }

            // Has power, missing site
            if (!hasSite && hasPower) {
                if (prefersSharing) return "Infra JV";
                return "Infra Partnership";
            }

            // Nothing substantial
            return "Pipeline Development";
        }

        // Get deal type explanation
        function getDealTypeWhy(dealType) {
            const hasPower = hasCategoryCore('power');
            const hasSite = hasCategoryCore('site');
            const hasOfftake = hasCategoryCore('offtake');
            const hasRiskPref = hasCategoryCore('capital');
            const customerType = state['offtake_customer'];
            const isHyperscaler = state['offtake_hyperscaler'];

            // Build missing items string
            const missing = [];
            if (!hasPower) missing.push('power & grid');
            if (!hasSite) missing.push('site');
            const missingStr = missing.join(' and ');

            // Hyperscaler-specific explanations
            if (isHyperscaler) {
                const hyperExplanations = {
                    "Self-Build": "You have all assets + hyperscaler demand. PUSH FOR OWNERSHIP. Don't give up equity - their IG credit unlocks 60-70% project debt. You're in the strongest negotiating position.",
                    "Capital Partnership": "You have the assets but need capital. Hyperscaler contract makes this highly financeable - you have leverage. Negotiate dev fee ($10-20M) + promote (20%+ above hurdle) + operating control.",
                    "Infra Partnership": `Missing ${missingStr}, but you have hyperscaler demand - that's your leverage. Partner for the gaps but push to retain majority ownership. Don't let the partner extract too much value.`,
                    "Infra JV": `Missing ${missingStr}, but hyperscaler demand is strong leverage. JV structure lets you share risk while preserving upside. Ensure Crusoe controls operations and customer relationship.`,
                    "Site JV": "Site partner brings land, you bring hyperscaler demand. JV shares risk but your demand is the unlock - negotiate strong operating control and expansion rights.",
                    "Hyperscaler-Backed": "Missing key assets but have hyperscaler demand. Let them fund the project. Negotiate: O&M fees ($8-15/kW/yr), potential minority equity (10-20%), and long-term operating agreement.",
                    "Find Offtake First": "You have infrastructure ready. With hyperscaler interest, push to convert to signed LOI/contract before engaging other partners or lenders.",
                    "Pipeline Development": "Early stage but hyperscaler interest is valuable. Use it to attract site/power partners. Don't over-commit on structure until you have more assets."
                };
                return hyperExplanations[dealType] || "";
            }

            // Standard explanations
            const explanations = {
                "Self-Build": "You have all key assets: power, site, offtake, and capital. Maximize ownership and returns with a project finance structure. You're in the driver's seat.",
                "Self-Build (Spec)": "You have infrastructure but no committed offtake - spec/merchant risk. This requires strong conviction in demand and significant balance sheet capacity. Consider multi-tenant or pre-leasing to de-risk.",
                "Capital Partnership": "You have power, site, and demand locked - but Crusoe needs outside equity. A capital partner (like Brookfield or DigitalBridge) fills this gap while you retain development and operating control.",
                "Capital Partnership (Spec Risk)": "Building spec without committed offtake AND need outside capital. This is a tough sell - partners want contracted cash flows. Consider multi-tenant with signed customers or get LOIs first.",
                "Infra Partnership": `You're missing ${missingStr}. Partner with a utility, developer, or infrastructure player who has these assets. Your ${hasOfftake ? 'demand' : 'expertise'} is your leverage.`,
                "Infra JV": `You're missing ${missingStr}. Form a JV with an infrastructure partner who has these assets. Shared ownership aligns incentives - partner gets upside from your demand, you get access to their assets.`,
                "Site Partnership": "Site partner brings land and potentially permits. Structure as lease or partnership based on relative contributions. Your demand unlocks value for their land.",
                "Site JV": "Form JV with site owner for shared equity. Partner contributes land, you contribute demand and operations. Align on governance and expansion rights for multi-phase growth.",
                "Hyperscaler-Backed": "You have hyperscaler demand - they can bring or fund power, site, and grid access. Let them finance the project. You execute and operate for fees or minority equity.",
                "Find Offtake First": "You have power and site ready, but no contracted demand. Focus on securing an anchor customer (hyperscaler or well-funded AI company) before finalizing financing. Offtake is the critical unlock.",
                "Pipeline Development": "You're in sourcing mode. Focus on finding opportunities - power, site, or demand. Deal structure decisions come after you have assets to work with."
            };

            return explanations[dealType] || "";
        }

        // Get gaps
        function getGaps() {
            const gaps = [];
            const has = [];

            if (hasCategoryCore('power')) has.push('Power & Grid');
            else gaps.push('Power & Grid');

            if (hasCategoryCore('site')) has.push('Site');
            else gaps.push('Site');

            if (hasCategoryCore('epc')) has.push('EPC');
            else gaps.push('EPC');

            if (hasCategoryCore('offtake')) has.push('Offtake');
            else gaps.push('Offtake');

            if (hasCategoryCore('capital')) has.push('Risk Appetite');
            else gaps.push('Risk Appetite');

            return { gaps, has };
        }

        // Get suggested partners based on gaps
        function getSuggestedPartners() {
            const { gaps } = getGaps();
            const dealType = determineDealType();
            const suggestions = [];

            // Always show financing partners for actionable deal types
            if (dealType === 'Self-Build') {
                suggestions.push({
                    title: 'FOR DEBT FINANCING:',
                    partners: partners.debt
                });
                suggestions.push({
                    title: 'FOR PREFERRED (IF NEEDED):',
                    partners: partners.preferred
                });
            }

            if (dealType === 'Capital Partnership') {
                suggestions.push({
                    title: 'FOR EQUITY CAPITAL:',
                    partners: partners.capital
                });
                suggestions.push({
                    title: 'FOR DEBT FINANCING:',
                    partners: partners.debt.slice(0, 2)
                });
            }

            if (dealType === 'Infra Partnership') {
                if (gaps.includes('Power')) {
                    suggestions.push({
                        title: 'FOR POWER SUPPLY:',
                        partners: partners.power
                    });
                }
                if (gaps.includes('Site')) {
                    suggestions.push({
                        title: 'FOR SITE / LAND:',
                        partners: partners.site
                    });
                }
                if (gaps.includes('Interconnection')) {
                    suggestions.push({
                        title: 'FOR INTERCONNECTION:',
                        partners: partners.interconnection
                    });
                }
            }

            if (dealType === 'Site Partnership') {
                suggestions.push({
                    title: 'FOR DEBT FINANCING:',
                    partners: partners.debt.slice(0, 2)
                });
            }

            if (dealType === 'Hyperscaler-Backed') {
                suggestions.push({
                    title: 'HYPERSCALER PARTNERS:',
                    partners: partners.offtake.filter(p => p.desc.includes('Hyperscaler'))
                });
            }

            if (dealType === 'Find Offtake First') {
                suggestions.push({
                    title: 'POTENTIAL OFFTAKERS:',
                    partners: partners.offtake
                });
            }

            if (dealType === 'Pipeline Development') {
                suggestions.push({
                    title: 'TO SOURCE OPPORTUNITIES:',
                    partners: [
                        { name: "Utilities & ISOs", desc: "For interconnection pipeline and grid access" },
                        { name: "Land developers", desc: "QTS, Lancium, DataBank for site opportunities" },
                        { name: "Hyperscalers", desc: "Microsoft, Oracle for demand-led opportunities" }
                    ]
                });
            }

            return suggestions;
        }

        // Render checklist
        function renderChecklist() {
            const container = document.getElementById('checklist');
            container.innerHTML = '';

            categories.forEach(cat => {
                const status = getCategoryStatus(cat);
                const shouldExpand = status !== 'yes';

                const categoryEl = document.createElement('div');
                categoryEl.className = `category ${shouldExpand ? 'expanded' : ''}`;
                
                let itemsHtml = '';
                
                if (cat.type === 'radio') {
                    // Radio-style category with mutually exclusive options
                    itemsHtml = cat.options.map(opt => {
                        const isSelected = state[opt.id];
                        const subItemsHtml = opt.subItems.length > 0 ? `
                            <div class="sub-items-nested" style="display: ${isSelected ? 'block' : 'none'}; margin-left: 28px; margin-top: 8px;">
                                ${opt.subItems.map(sub => renderItem(sub, isSelected)).join('')}
                            </div>
                        ` : '';
                        
                        return `
                            <label class="sub-item radio-option">
                                <input type="radio" name="${cat.radioName}" ${isSelected ? 'checked' : ''} onchange="updateRadio('${cat.id}', '${opt.id}')">
                                <span class="radio-circle"></span>
                                <span class="label">${opt.label}</span>
                            </label>
                            ${subItemsHtml}
                        `;
                    }).join('');
                } else if (cat.type === 'conditional') {
                    // Conditional category - sub-items shown when parent is checked
                    const parentChecked = state[cat.parentItem.id];
                    itemsHtml = `
                        <label class="sub-item">
                            <input type="checkbox" ${parentChecked ? 'checked' : ''} onchange="updateCheck('${cat.parentItem.id}', this.checked)">
                            <span class="checkbox"></span>
                            <span class="label">${cat.parentItem.label}</span>
                        </label>
                        <div class="sub-items-nested" style="display: ${parentChecked ? 'block' : 'none'}; margin-left: 28px; margin-top: 8px;">
                            ${cat.subItems.map(sub => renderItem(sub, parentChecked)).join('')}
                        </div>
                    `;
                } else if (cat.type === 'simple') {
                    // Simple category with just checkboxes
                    itemsHtml = cat.items.map(item => renderItem(item, true)).join('');
                }
                
                categoryEl.innerHTML = `
                    <div class="category-header" onclick="toggleCategory('${cat.id}')">
                        <div class="left">
                            <div class="category-status ${status}">${status === 'yes' ? '✓' : status === 'partial' ? '◐' : '✗'}</div>
                            <span class="name">${cat.name}</span>
                        </div>
                        <span class="category-toggle">▼</span>
                    </div>
                    <div class="category-items">
                        <div class="category-items-inner">
                            ${itemsHtml}
                        </div>
                    </div>
                `;
                container.appendChild(categoryEl);
            });
        }
        
        // Helper to render individual items
        function renderItem(item, enabled) {
            const disabledClass = enabled ? '' : 'disabled';
            const disabledAttr = enabled ? '' : 'disabled';
            
            if (item.type === 'select') {
                return `
                    <label class="sub-item special ${disabledClass}">
                        <span class="label">${item.label}</span>
                        <select ${disabledAttr} onchange="updateSelect('${item.id}', this.value)">
                            ${item.options.map(opt => `
                                <option value="${opt}" ${state[item.id] === opt ? 'selected' : ''}>${opt}</option>
                            `).join('')}
                        </select>
                    </label>
                `;
            }
            return `
                <label class="sub-item ${disabledClass}">
                    <input type="checkbox" ${state[item.id] ? 'checked' : ''} ${disabledAttr} onchange="updateCheck('${item.id}', this.checked)">
                    <span class="checkbox"></span>
                    <span class="label">${item.label}</span>
                </label>
            `;
        }
        
        // Handle radio button changes
        function updateRadio(catId, optionId) {
            const cat = categories.find(c => c.id === catId);
            // Uncheck all options in this category
            cat.options.forEach(opt => {
                state[opt.id] = false;
                // Also uncheck all sub-items
                opt.subItems.forEach(sub => {
                    if (sub.type !== 'select') state[sub.id] = false;
                });
            });
            // Check the selected option
            state[optionId] = true;
            saveState();
            renderChecklist();
            renderResults();
            updateProgressBar();
        }

        // Get snapshot data for each category
        function getSnapshotData() {
            const snapshot = [];
            
            // Power & Grid (merged)
            if (state['power_offgrid']) {
                snapshot.push({ label: 'Power & Grid', has: true, value: 'Off-grid / BTM (no IX needed)' });
            } else if (state['power_grid']) {
                let gridStatus = 'Grid-connected';
                if (state['ix_approved']) {
                    gridStatus += ', IA approved';
                    if (state['ix_utility']) gridStatus += ', utility signed';
                } else if (state['ix_inqueue']) {
                    gridStatus += ', IX in queue';
                } else {
                    gridStatus += ', IX status unknown';
                }
                if (state['power_longterm']) gridStatus += ', 5+ yr contract';
                const hasIxApproval = state['ix_approved'] || state['power_offgrid'];
                snapshot.push({ label: 'Power & Grid', has: hasIxApproval, value: gridStatus });
            } else {
                snapshot.push({ label: 'Power & Grid', has: false, value: 'Not selected' });
            }
            
            // Site
            if (state['site_owned']) {
                snapshot.push({ label: 'Site', has: true, value: 'Owned/leased' });
            } else if (state['site_partner_other']) {
                snapshot.push({ label: 'Site', has: true, value: 'Site partner arrangement' });
            } else if (state['site_no']) {
                snapshot.push({ label: 'Site', has: false, value: 'Still sourcing' });
            } else {
                snapshot.push({ label: 'Site', has: false, value: 'Not selected' });
            }
            
            // Offtake
            if (state['offtake_hyperscaler']) {
                const longterm = state['offtake_hs_longterm'] ? ', 10+ yr contract' : '';
                snapshot.push({ label: 'Offtake', has: true, value: 'Hyperscaler' + longterm });
            } else if (state['offtake_aicompany']) {
                const funded = state['offtake_ai_funded'] ? 'Well-funded' : '';
                const longterm = state['offtake_ai_longterm'] ? '3+ yr contract' : '';
                const details = [funded, longterm].filter(x => x).join(', ');
                snapshot.push({ label: 'Offtake', has: true, value: 'AI Company' + (details ? ' (' + details + ')' : '') });
            } else if (state['offtake_multitenant']) {
                const committed = state['offtake_mt_committed'] ? ', 3+ signed' : ', not committed';
                snapshot.push({ label: 'Offtake', has: state['offtake_mt_committed'], value: 'Multi-tenant' + committed });
            } else if (state['offtake_spec']) {
                snapshot.push({ label: 'Offtake', has: false, value: 'Spec / No commitment' });
            } else {
                snapshot.push({ label: 'Offtake', has: false, value: 'Not selected' });
            }
            
            // Risk Appetite
            if (state['pref_maximize']) {
                snapshot.push({ label: 'Risk Appetite', has: true, value: 'Maximize ownership', showIcon: false });
            } else if (state['pref_share']) {
                snapshot.push({ label: 'Risk Appetite', has: true, value: 'Share with partner', showIcon: false });
            } else if (state['pref_nopreference']) {
                snapshot.push({ label: 'Risk Appetite', has: true, value: 'No preference', showIcon: false });
            } else {
                snapshot.push({ label: 'Risk Appetite', has: false, value: 'Not selected', showIcon: false });
            }
            
            // EPC
            if (state['epc_selfbuild']) {
                snapshot.push({ label: 'EPC', has: true, value: 'Crusoe self-build' });
            } else if (state['epc_external']) {
                snapshot.push({ label: 'EPC', has: true, value: 'External contractor' });
            } else {
                snapshot.push({ label: 'EPC', has: false, value: 'Not selected' });
            }
            
            return snapshot;
        }

        // Render results
        function renderResults() {
            const dealType = determineDealType();
            const fin = financials[dealType] || financials['Self-Build'];
            const { gaps, has } = getGaps();
            const suggestedPartners = getSuggestedPartners();
            const nextSteps = getNextSteps();
            const snapshot = getSnapshotData();

            // Render snapshot
            const isReady = gaps.length === 0;
            const snapshotHtml = snapshot.map(item => {
                const iconHtml = item.showIcon === false ? '' : `<span class="snapshot-icon ${item.has ? 'yes' : 'no'}">${item.has ? '✓' : '✗'}</span>`;
                const itemClass = `snapshot-item ${item.showIcon === false ? 'no-icon' : ''}`.trim();
                return `
                    <div class="${itemClass}">
                        ${iconHtml}
                        <div class="snapshot-info">
                            <div class="snapshot-label">${item.label}</div>
                            <div class="snapshot-value">${item.value}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            const statusHtml = isReady 
                ? '<span class="snapshot-status ready">Deal Ready</span>'
                : '<span class="snapshot-status not-ready">' + gaps.length + ' Gap' + (gaps.length > 1 ? 's' : '') + ' to Close</span>';
            
            document.getElementById('snapshotGrid').innerHTML = snapshotHtml + statusHtml;

            // Deal type badge
            document.getElementById('dealTypeBadge').textContent = dealType;
            document.getElementById('dealTypeBadgeHeader').textContent = dealType;
            
            // Metrics inline
            document.getElementById('metricOwnership').textContent = fin.ownership.split(' ')[0];
            document.getElementById('metricRisk').textContent = fin.risk;
            document.getElementById('metricReturn').textContent = fin.return;
            
            // Executive summary text
            const summaryText = getSummaryText(dealType, gaps, has);
            document.getElementById('summaryText').textContent = summaryText;

            // Get config for this deal type
            const config = dealTypeConfig[dealType] || dealTypeConfig['Self-Build'];
            const dealRows = config.rows || ['Capital', 'Execution'];
            const dealPartners = config.partners || [];

            // Build strategy matrix rows
            const matrixRowsHtml = dealRows.map(row => {
                const rowType = typeof row === 'string' ? row : row.type;
                const rowLabel = typeof row === 'string' ? row : row.label;
                const rowData = matrixRows[rowType];
                if (!rowData) return '';
                
                const wantList = rowData.want.map(item => `<li>${addTooltips(item)}</li>`).join('');
                const winList = rowData.win.map(item => `<li>${addTooltips(item)}</li>`).join('');
                const risksList = rowData.risks.map(item => `<li>${addTooltips(item)}</li>`).join('');
                
                return `
                    <div class="matrix-row-label">${rowLabel}</div>
                    <div class="matrix-cell"><ul>${wantList}</ul></div>
                    <div class="matrix-cell"><ul>${winList}</ul></div>
                    <div class="matrix-cell"><ul>${risksList}</ul></div>
                `;
            }).join('');

            // Build partners section
            const partnersHtml = dealPartners.length > 0
                ? dealPartners.map(p => `
                    <div class="partner-row">
                        <span class="partner-name">${p.name}</span>
                        <span class="partner-desc">${p.desc}</span>
                    </div>
                `).join('')
                : '<span style="color: var(--text-muted);">Complete inputs to see partner recommendations.</span>';

            // Build next steps
            const nextStepsList = nextSteps.slice(0, 3).map(step => {
                const style = step.type === 'financing' ? 'font-weight: 600;' : '';
                return `
                    <div class="next-step-item" style="${style}">
                        <span class="next-step-arrow">→</span>
                        <span>${step.text}</span>
                    </div>
                `;
            }).join('');

            const economicsLine = `IRR ${fin.irr || '—'} • Debt: ${fin.debtCost || '—'} • Equity: ${fin.equityCheck || '—'}`;

            // Capital stack visualization (mini version for inline display)
            const showCapitalStack = fin.debtPct > 0 || fin.equityPct > 0;
            const miniStackHtml = showCapitalStack ? `
                <div class="deal-summary-right">
                    <div class="mini-stack-title">Capital Stack</div>
                    <div class="mini-stack-bar">
                        ${fin.debtPct > 0 ? `<div class="stack-segment debt" style="width: ${fin.debtPct}%;">${fin.debtPct}%</div>` : ''}
                        ${fin.equityPct > 0 ? `<div class="stack-segment equity" style="width: ${fin.equityPct}%;">${fin.equityPct}%</div>` : ''}
                    </div>
                    <div class="mini-stack-labels">
                        <span>${fin.debtLabel || 'Debt'}</span>
                        <span>${fin.equityLabel || 'Equity'}</span>
                    </div>
                </div>
            ` : '';

            const dealCardHtml = `
                <div class="deal-output">
                    <div class="deal-summary-block">
                        <div class="deal-summary-left">
                            <div class="summary-row"><span class="summary-label">Structure:</span><span>${fin.structure || '—'}</span></div>
                            <div class="summary-row"><span class="summary-label">Economics:</span><span>${economicsLine}</span></div>
                            <div class="summary-row" style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">*Based on $1B total project cost</div>
                        </div>
                        ${miniStackHtml}
                    </div>

                    <div class="strategy-matrix">
                        <div class="matrix-head empty"></div>
                        <div class="matrix-head">What partners want</div>
                        <div class="matrix-head">How to win</div>
                        <div class="matrix-head">Risks</div>
                        ${matrixRowsHtml}
                    </div>

                    <div class="partners-section">
                        <div class="partners-section-title">Suggested Partners</div>
                        <div class="partners-list">
                            ${partnersHtml}
                        </div>
                    </div>

                    <div class="next-steps-section">
                        <div class="next-steps-title">Next steps</div>
                        ${nextStepsList || '<span style="color: var(--text-muted);">Complete inputs to see next steps.</span>'}
                    </div>
                </div>
            `;

            document.getElementById('summaryDetails').innerHTML = dealCardHtml;
        }
        
        function getSummaryText(dealType, gaps, has) {
            if (dealType === 'Site Partnership') {
                return 'Site partner brings land/infrastructure. Negotiate economics based on relative contribution - you bring offtake and operations.';
            }
            
            if (dealType === 'Site JV') {
                return 'Form JV with site owner for shared equity upside. Align on governance, capital contributions, and expansion rights. Crusoe leads build and operations.';
            }
            
            if (dealType === 'Infra JV') {
                return 'Form JV with infrastructure partner for shared ownership. Fair asset valuation is key. Crusoe brings demand and operations, partner brings power/IX assets.';
            }
            
            if (gaps.length === 0) {
                if (dealType === 'Self-Build') {
                    return 'You have all key elements in place. Maximize ownership with project finance - you can access 55-65% debt and keep 100% equity.';
                } else if (dealType.includes('Hyperscaler')) {
                    return 'With hyperscaler backing, prioritize speed and scale over ownership. Their credit unlocks favorable financing.';
                } else if (dealType.includes('Capital Partnership')) {
                    return 'Partner with infrastructure capital to share development risk and accelerate deployment.';
                }
            }
            
            if (dealType === 'Hyperscaler-Backed') {
                return 'Hyperscaler demand is your key asset. Structure a build-to-suit or powered shell arrangement where they fund the project and you operate for fees and potential minority equity.';
            }
            
            if (gaps.length === 1) {
                return `Almost there. Address ${gaps[0].toLowerCase()} to unlock better financing terms.`;
            }
            
            return `Focus on securing ${gaps.slice(0, 2).join(' and ').toLowerCase()} first. This will clarify your optimal deal structure.`;
        }

        // Toggle category
        function toggleCategory(catId) {
            const el = document.querySelector(`.category:has([onclick*="${catId}"])`);
            el.classList.toggle('collapsed');
        }

        // Update checkbox
        function updateCheck(id, checked) {
            state[id] = checked;
            saveState();
            renderWizardSteps();
            renderWizardContent();
        }

        // Update select
        function updateSelect(id, value) {
            state[id] = value;
            saveState();
            renderWizardSteps();
            renderWizardContent();
        }

        // Update input field
        function updateInput(id, value) {
            state[id] = value;
            saveState();
            renderResults();
        }

        // Reset
        function resetChecklist() {
            categories.forEach(cat => {
                if (cat.type === 'radio') {
                    cat.options.forEach(opt => {
                        state[opt.id] = false;
                        opt.subItems.forEach(sub => {
                            if (sub.type === 'select') {
                                state[sub.id] = sub.options[0];
                            } else {
                                state[sub.id] = false;
                            }
                        });
                    });
                } else if (cat.type === 'conditional') {
                    state[cat.parentItem.id] = false;
                    cat.subItems.forEach(sub => {
                        if (sub.type === 'select') {
                            state[sub.id] = sub.options[0];
                        } else {
                            state[sub.id] = false;
                        }
                    });
                } else if (cat.type === 'simple') {
                    cat.items.forEach(item => {
                        if (item.type === 'select') {
                            state[item.id] = item.options[0];
                        } else {
                            state[item.id] = false;
                        }
                    });
                }
            });
            saveState();
            currentStep = 0;
            renderWizardSteps();
            renderWizardContent();
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('resultsContent').style.display = 'none';
        }

        // Render input summary on right side
        function renderInputSummary() {
            const container = document.getElementById('summaryItems');
            const items = categories.map(cat => {
                const complete = hasCategoryCore(cat.id);
                return `<div class="summary-item ${complete ? 'complete' : 'incomplete'}">
                    <span class="icon">${complete ? '✓' : '○'}</span>
                    <span>${cat.name}</span>
                </div>`;
            });
            container.innerHTML = items.join('');
        }

        // Generate next steps based on current state
        function getNextSteps() {
            const steps = [];
            const dealType = determineDealType();
            const { gaps } = getGaps();
            const isHyperscaler = state['offtake_hyperscaler'];
            
            // Gap-based steps
            if (gaps.includes('Power')) {
                steps.push({ type: 'action', text: 'Secure power supply - negotiate PPA or confirm off-grid source' });
            } else if (state['power_grid'] && !state['power_longterm']) {
                steps.push({ type: 'action', text: 'Extend PPA to 5+ years - needed for project financing' });
            }
            
            if (gaps.includes('Site')) {
                steps.push({ type: 'action', text: 'Secure site control - execute land lease or purchase agreement' });
            }
            
            // Grid-connected projects: check IX status
            if (state['power_grid'] && !state['power_offgrid']) {
                if (!state['ix_inqueue'] && !state['ix_approved']) {
                    steps.push({ type: 'action', text: 'File interconnection application and secure queue position' });
                } else if (state['ix_inqueue'] && !state['ix_approved']) {
                    steps.push({ type: 'action', text: 'Advance interconnection through study process toward IA execution' });
                }
                // Utility agreement needed for debt financing
                if (state['ix_approved'] && !state['ix_utility']) {
                    steps.push({ type: 'action', text: 'Execute utility agreement - required for project debt financing' });
                }
            }
            
            if (gaps.includes('Offtake')) {
                steps.push({ type: 'action', text: 'Identify and engage anchor customer - hyperscaler or AI company' });
            }
            
            // Hyperscaler-specific steps
            const isHyperscalerOfftake = state['offtake_hyperscaler'];
            if (isHyperscalerOfftake) {
                if (!state['offtake_hs_longterm']) {
                    steps.push({ type: 'action', text: 'Secure 10+ year term with annual escalators in hyperscaler contract' });
                }
                steps.push({ type: 'action', text: 'Get commitment letter from hyperscaler for lender/partner conversations' });
                if (dealType !== 'Self-Build' && hasCategoryCore('power') && hasCategoryCore('site')) {
                    steps.push({ type: 'warning', text: 'You have assets - push for ownership before accepting build-to-suit structure' });
                }
            }
            
            // AI Company steps
            const isAICompanyOfftake = state['offtake_aicompany'];
            if (isAICompanyOfftake) {
                if (!state['offtake_ai_funded']) {
                    steps.push({ type: 'action', text: 'Confirm customer funding status (Series C+ or $500M+ raised) for financing discussions' });
                }
                if (!state['offtake_ai_longterm']) {
                    steps.push({ type: 'action', text: 'Negotiate 3+ year contract term to support project debt' });
                }
                if (state['offtake_ai_funded'] && state['offtake_ai_longterm']) {
                    steps.push({ type: 'action', text: 'Get signed LOI or term sheet to begin lender conversations' });
                }
            }
            
            // Multi-tenant steps
            if (state['offtake_multitenant'] && !state['offtake_mt_committed']) {
                steps.push({ type: 'warning', text: 'Multi-tenant without signed customers = spec risk. Secure 3+ commitments first.' });
            }
            
            // Deal type specific steps
            if (dealType === 'Capital Partnership' || dealType === 'Capital Partnership (Spec Risk)') {
                steps.push({ type: 'action', text: 'Prepare investment memo and financial model for capital partner outreach' });
            }
            
            if (dealType === 'Hyperscaler-Backed' && !isHyperscaler) {
                steps.push({ type: 'action', text: 'Structure build-to-suit or powered shell proposal for hyperscaler' });
            }
            
            if (dealType === 'Self-Build' || dealType === 'Self-Build (Spec)') {
                if (!state.project_capex) {
                    steps.push({ type: 'action', text: 'Finalize capex budget and confirm equity commitment with IC' });
                }
            }
            
            // Ensure minimum 3 steps with deal-type specific defaults
            const defaultSteps = {
                'Self-Build': [
                    { type: 'action', text: 'Engage 2-3 lead arrangers for debt financing competitive process' },
                    { type: 'action', text: 'Finalize EPC contract with appropriate LDs and timeline' },
                    { type: 'action', text: 'Complete financial model and IC memo for internal approval' }
                ],
                'Self-Build (Spec)': [
                    { type: 'action', text: 'Develop LOI pipeline with 3+ potential customers' },
                    { type: 'action', text: 'Build multi-tenant leasing strategy to diversify risk' },
                    { type: 'action', text: 'Prepare investor materials highlighting demand thesis' }
                ],
                'Capital Partnership': [
                    { type: 'action', text: 'Prepare 2-page teaser and detailed investment memo' },
                    { type: 'action', text: 'Build target list of 5-10 capital partners' },
                    { type: 'action', text: 'Structure term sheet with promote and governance terms' }
                ],
                'Capital Partnership (Spec Risk)': [
                    { type: 'action', text: 'Secure LOIs from potential customers before partner outreach' },
                    { type: 'action', text: 'Prepare investment memo highlighting demand pipeline' },
                    { type: 'action', text: 'Identify partners with AI/data center thesis' }
                ],
                'Infra Partnership': [
                    { type: 'action', text: 'Identify infrastructure gaps and target partners to fill them' },
                    { type: 'action', text: 'Prepare JV term sheet with clear role delineation' },
                    { type: 'action', text: 'Negotiate operating control and customer ownership' }
                ],
                'Site Partnership': [
                    { type: 'action', text: 'Negotiate site contribution value and ownership split' },
                    { type: 'action', text: 'Define development timeline and milestone payments' },
                    { type: 'action', text: 'Structure operating agreement with clear responsibilities' }
                ],
                'Site JV': [
                    { type: 'action', text: 'Negotiate JV equity split based on land value vs. demand value' },
                    { type: 'action', text: 'Define governance structure - board seats, major decision thresholds' },
                    { type: 'action', text: 'Lock in expansion rights and Phase 2/3 site options' }
                ],
                'Infra JV': [
                    { type: 'action', text: 'Commission independent valuation of contributed infrastructure' },
                    { type: 'action', text: 'Define operating roles - Crusoe leads ops, partner maintains assets' },
                    { type: 'action', text: 'Structure capacity expansion roadmap with committed MW milestones' }
                ],
                'Hyperscaler-Backed': [
                    { type: 'action', text: 'Prepare capacity and timeline proposal for hyperscaler' },
                    { type: 'action', text: 'Negotiate O&M fees and long-term operating agreement' },
                    { type: 'action', text: 'Structure potential minority equity or upside participation' }
                ],
                'Find Offtake First': [
                    { type: 'action', text: 'Prioritize BD outreach to hyperscalers and well-funded AI companies' },
                    { type: 'action', text: 'Prepare site/capacity pitch deck for customer meetings' },
                    { type: 'action', text: 'Get LOI or term sheet before advancing site development' }
                ],
                'Pipeline Development': [
                    { type: 'action', text: 'Source sites with power and interconnection potential' },
                    { type: 'action', text: 'Build relationships with utilities for grid access opportunities' },
                    { type: 'action', text: 'Develop customer pipeline through BD outreach' }
                ]
            };
            
            // Add default steps if we have fewer than 3
            const defaults = defaultSteps[dealType] || defaultSteps['Self-Build'];
            let i = 0;
            while (steps.length < 3 && i < defaults.length) {
                // Only add if not already similar
                const defaultText = defaults[i].text.toLowerCase();
                const alreadyHas = steps.some(s => s.text.toLowerCase().includes(defaultText.slice(0, 20)));
                if (!alreadyHas) {
                    steps.push(defaults[i]);
                }
                i++;
            }
            
            // Merge financing strategy into steps for ALL deal types (max 2-3 items)
            const financingStrategy = getFinancingStrategy();
            let financingCount = 0;
            financingStrategy.forEach(section => {
                section.items.forEach(item => {
                    if (financingCount < 3) {  // Cap financing items at 3
                        steps.unshift({ 
                            type: 'financing', 
                            text: item
                        });
                        financingCount++;
                    }
                });
            });
            
            return steps.slice(0, 6); // Increase from 5 to 6 total steps
        }

        // Generate financing strategy
        function getFinancingStrategy() {
            const dealType = determineDealType();
            const sections = [];
            const isHyperscaler = state['offtake_anchor'] && state['offtake_customer'] === 'Hyperscaler';
            const creditQuality = state['offtake_credit'];
            const hasUtilityAgreement = state['ix_utility'];
            const projectMW = state.project_mw;
            const projectCapex = state.project_capex;
            
            // Self-Build financing strategy
            if (dealType === 'Self-Build' || dealType === 'Self-Build (Spec)') {
                const debtItems = [
                    'Target 55-65% leverage with senior secured debt',
                    'Engage 2-3 lead arrangers (JP Morgan, MUFG, Brookfield Credit)',
                    'Prepare lender presentation with contracted cash flows'
                ];
                
                // Credit quality affects debt terms
                if (creditQuality === 'Investment Grade') {
                    debtItems.push('IG offtaker credit enables tighter pricing (SOFR + 200-250bps)');
                } else if (creditQuality === 'Sub-IG') {
                    debtItems.push('Sub-IG credit may require credit enhancement or higher spread');
                }
                
                // Project size context
                if (projectCapex && parseFloat(projectCapex) > 200) {
                    debtItems.push('Large deal ($' + projectCapex + 'M) - consider club deal or syndication');
                }
                
                sections.push({
                    title: 'Debt Financing Strategy',
                    items: debtItems
                });
                if (dealType === 'Self-Build (Spec)') {
                    sections.push({
                        title: 'Spec Risk Mitigation',
                        items: [
                            'Secure LOIs or pre-lease commitments to improve debt terms',
                            'Consider delayed draw or construction-only facility',
                            'Build in flexibility for tenant improvements',
                            'Plan for higher equity contribution (40-50%)'
                        ]
                    });
                }
            }
            
            // Capital Partnership strategy
            if (dealType.includes('Capital Partnership')) {
                const outreachItems = [
                    'Prepare 2-page teaser and detailed investment memo',
                    'Build financial model showing 15-20% levered IRR base case',
                    'Target partners: Brookfield, DigitalBridge, KKR Infra'
                ];
                
                if (creditQuality === 'Investment Grade') {
                    outreachItems.push('Highlight IG offtaker credit - makes deal highly bankable');
                }
                
                if (projectMW && parseFloat(projectMW) > 100) {
                    outreachItems.push('At ' + projectMW + 'MW, this is institutional scale - emphasize platform potential');
                }
                
                sections.push({
                    title: 'Capital Partner Outreach',
                    items: outreachItems
                });
                sections.push({
                    title: 'Negotiation Priorities',
                    items: [
                        'Retain GP/managing member control',
                        'Secure development fee ($10-20M depending on size)',
                        'Push for 20%+ promote above preferred return',
                        'Keep operating and asset management fees'
                    ]
                });
            }
            
            // Hyperscaler-Backed strategy
            if (dealType === 'Hyperscaler-Backed') {
                const pitchItems = [
                    'Lead with capacity, timeline, and location advantages',
                    'Propose pricing: $/kW/month or $/MWh all-in',
                    'Offer build-to-suit with long-term O&M agreement'
                ];
                
                if (projectMW) {
                    pitchItems.push('Position ' + projectMW + 'MW as phase 1 with expansion potential');
                }
                
                pitchItems.push('Highlight Crusoe operational track record and GPU expertise');
                
                sections.push({
                    title: 'Hyperscaler Pitch Strategy',
                    items: pitchItems
                });
                sections.push({
                    title: 'Deal Structure Options',
                    items: [
                        'Powered shell: Hyperscaler funds all, you operate for fees',
                        'JV: Hyperscaler takes 80%, you retain 20% + fees',
                        'Build-to-suit: Sell at COD, sign back O&M contract',
                        'Push for O&M fees of $8-15/kW/year'
                    ]
                });
            }
            
            // Infra Partnership strategy
            if (dealType === 'Infra Partnership') {
                sections.push({
                    title: 'Partner Approach',
                    items: [
                        'Identify what you bring vs. what partner brings',
                        'Lead conversations with your demand or power advantage',
                        'Propose JV structure with clear role delineation',
                        'Target utilities, land developers, or IX holders'
                    ]
                });
                sections.push({
                    title: 'Structure Considerations',
                    items: [
                        'Push for majority ownership if you bring demand',
                        'Negotiate development and operating fees regardless of equity split',
                        'Align on timeline and decision-making process upfront',
                        'Consider asset-level vs. portfolio-level partnership'
                    ]
                });
            }
            
            // Pipeline Development
            if (dealType === 'Pipeline Development' || dealType === 'Find Offtake First') {
                sections.push({
                    title: 'Priority Actions',
                    items: [
                        'Focus on securing the missing pieces before financing conversations',
                        'Build relationships with potential partners for future deals',
                        'Develop pipeline of sites, power, and interconnection opportunities',
                        'Structure will follow once assets are in place'
                    ]
                });
            }
            
            return sections;
        }

        // Render next steps
        function renderNextSteps() {
            const steps = getNextSteps();
            const container = document.getElementById('nextSteps');
            
            if (steps.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); font-size: 1.6rem;">Complete more inputs to see recommended next steps.</p>';
                return;
            }
            
            container.innerHTML = steps.map((step, i) => `
                <div class="step-item ${step.type === 'risk' ? 'risk' : step.type === 'warning' ? 'warning' : ''}">
                    <span class="step-number">${step.type === 'risk' ? '!' : step.type === 'warning' ? '⚠' : i + 1}</span>
                    <span class="step-text">${step.text}</span>
                </div>
            `).join('');
        }

        // Render financing strategy
        function renderFinancingChecklist() {
            const sections = getFinancingStrategy();
            const container = document.getElementById('financingChecklist');
            
            if (sections.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); font-size: 1.6rem;">Complete readiness checklist to see financing strategy.</p>';
                return;
            }
            
            container.innerHTML = sections.map(section => `
                <div class="financing-section">
                    <div class="financing-section-title">${section.title}</div>
                    <div class="financing-items">
                        ${section.items.map(item => `
                            <div class="financing-item">
                                <span class="strategy-bullet">→</span>
                                <span class="item-text">${item}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // ===== COLLAPSE / EXPAND =====
        function expandAll() {
            document.querySelectorAll('.category').forEach(cat => {
                cat.classList.remove('collapsed');
            });
        }

        function collapseAll() {
            document.querySelectorAll('.category').forEach(cat => {
                cat.classList.add('collapsed');
            });
        }

        // ===== PROGRESS BAR =====
        function updateProgressBar() {
            let complete = 0;
            const total = categories.length;
            
            categories.forEach(cat => {
                if (hasCategoryCore(cat.id)) {
                    complete++;
                }
            });
            
            const pct = Math.round((complete / total) * 100);
            document.getElementById('progressBar').style.setProperty('--progress', pct + '%');
            document.getElementById('progressText').textContent = complete + ' of ' + total + ' complete';
        }

        // ===== SCENARIO MANAGEMENT =====
        const SCENARIOS_KEY = 'crusoe_scenarios';

        function getScenarios() {
            const data = localStorage.getItem(SCENARIOS_KEY);
            return data ? JSON.parse(data) : [];
        }

        function saveScenarios(scenarios) {
            localStorage.setItem(SCENARIOS_KEY, JSON.stringify(scenarios));
        }

        function saveScenario() {
            const name = prompt('Scenario name:', 'Scenario ' + (getScenarios().length + 1));
            if (!name) return;
            
            const scenarios = getScenarios();
            const dealType = determineDealType();
            
            scenarios.push({
                id: Date.now().toString(),
                name: name,
                dealType: dealType,
                timestamp: new Date().toLocaleDateString(),
                state: JSON.parse(JSON.stringify(state))
            });
            
            saveScenarios(scenarios);
            renderSavedScenarios();
        }

        function loadScenario(id) {
            const scenarios = getScenarios();
            const scenario = scenarios.find(s => s.id === id);
            if (!scenario) return;
            
            Object.assign(state, scenario.state);
            saveState();
            renderWizardSteps();
            renderWizardContent();
            showResults();
        }

        function deleteScenario(id, event) {
            event.stopPropagation();
            if (!confirm('Delete this scenario?')) return;
            
            const scenarios = getScenarios().filter(s => s.id !== id);
            saveScenarios(scenarios);
            renderSavedScenarios();
        }

        function renderSavedScenarios() {
            const container = document.getElementById('savedScenarios');
            const scenarios = getScenarios();
            
            if (scenarios.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = `
                <div class="saved-scenarios-header">
                    <span class="saved-scenarios-title">Saved Scenarios</span>
                    <button class="compare-btn" onclick="openCompareModal()">Compare</button>
                </div>
                <div class="scenario-list">
                    ${scenarios.map(s => `
                        <div class="scenario-item" onclick="loadScenario('${s.id}')">
                            <div>
                                <span class="name">${s.name}</span>
                                <span class="meta"> - ${s.dealType}</span>
                            </div>
                            <span class="delete" onclick="deleteScenario('${s.id}', event)">×</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // ===== COMPARISON MODAL =====
        function openCompareModal() {
            const scenarios = getScenarios();
            if (scenarios.length < 2) {
                alert('Save at least 2 scenarios to compare.');
                return;
            }
            
            const options = scenarios.map(s => 
                `<option value="${s.id}">${s.name}</option>`
            ).join('');
            
            document.getElementById('compareA').innerHTML = '<option value="">Select Scenario A</option>' + options;
            document.getElementById('compareB').innerHTML = '<option value="">Select Scenario B</option>' + options;
            document.getElementById('comparisonTable').innerHTML = '<p style="color: var(--text-muted);">Select two scenarios to compare</p>';
            document.getElementById('compareModal').style.display = 'flex';
        }

        function closeCompareModal() {
            document.getElementById('compareModal').style.display = 'none';
        }

        function getDealTypeForState(s) {
            // Simplified deal type determination from saved state
            const hasOfftake = s['offtake_hyperscaler'] || s['offtake_aicompany'] || s['offtake_spec'] || s['offtake_multitenant'];
            const isHyperscaler = s['offtake_hyperscaler'];
            const prefersSharing = s['pref_share'];
            const isSpec = s['offtake_spec'];
            
            if (isHyperscaler && prefersSharing) return 'Hyperscaler-Backed';
            if (isHyperscaler) return 'Self-Build';
            if (isSpec && prefersSharing) return 'Capital Partnership (Spec)';
            if (isSpec) return 'Self-Build (Spec)';
            if (prefersSharing) return 'Capital Partnership';
            return 'Self-Build';
        }

        function getCategoryStatus(s, catId) {
            const cat = categories.find(c => c.id === catId);
            if (!cat) return { status: '?', detail: '' };
            
            if (cat.type === 'radio') {
                for (const opt of cat.options) {
                    if (s[opt.id]) {
                        return { status: 'yes', detail: opt.label.split(' ')[0] };
                    }
                }
                return { status: 'no', detail: 'Not set' };
            }
            
            if (cat.type === 'simple') {
                const item = cat.items[0];
                return s[item.id] ? { status: 'yes', detail: 'Yes' } : { status: 'no', detail: 'No' };
            }
            
            return { status: '?', detail: '' };
        }

        function updateComparison() {
            const aId = document.getElementById('compareA').value;
            const bId = document.getElementById('compareB').value;
            
            if (!aId || !bId) {
                document.getElementById('comparisonTable').innerHTML = '<p style="color: var(--text-muted);">Select two scenarios to compare</p>';
                return;
            }
            
            const scenarios = getScenarios();
            const a = scenarios.find(s => s.id === aId);
            const b = scenarios.find(s => s.id === bId);
            
            if (!a || !b) return;
            
            const dealTypeA = a.dealType || getDealTypeForState(a.state);
            const dealTypeB = b.dealType || getDealTypeForState(b.state);
            
            const catRows = ['power', 'site', 'epc', 'offtake', 'capital'].map(catId => {
                const statusA = getCategoryStatus(a.state, catId);
                const statusB = getCategoryStatus(b.state, catId);
                const cat = categories.find(c => c.id === catId);
                return `
                    <div class="comparison-row">
                        <div class="label">${cat ? cat.name : catId}</div>
                        <div class="value ${statusA.status}">${statusA.status === 'yes' ? '✓' : '✗'} ${statusA.detail}</div>
                        <div class="value ${statusB.status}">${statusB.status === 'yes' ? '✓' : '✗'} ${statusB.detail}</div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('comparisonTable').innerHTML = `
                <div class="comparison-row header">
                    <div></div>
                    <div>${a.name}</div>
                    <div>${b.name}</div>
                </div>
                <div class="comparison-row">
                    <div class="label">Deal Type</div>
                    <div class="value">${dealTypeA}</div>
                    <div class="value">${dealTypeB}</div>
                </div>
                ${catRows}
                <div class="comparison-row" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                    <div class="label">Ownership</div>
                    <div class="value">${dealTypeA.includes('Hyperscaler') ? '0-20%' : dealTypeA.includes('Capital') ? '30-50%' : '100%'}</div>
                    <div class="value">${dealTypeB.includes('Hyperscaler') ? '0-20%' : dealTypeB.includes('Capital') ? '30-50%' : '100%'}</div>
                </div>
                <div class="comparison-row">
                    <div class="label">Risk</div>
                    <div class="value">${dealTypeA.includes('Spec') ? 'High' : dealTypeA.includes('Hyperscaler') ? 'Low' : 'Medium'}</div>
                    <div class="value">${dealTypeB.includes('Spec') ? 'High' : dealTypeB.includes('Hyperscaler') ? 'Low' : 'Medium'}</div>
                </div>
                <div class="comparison-row">
                    <div class="label">Return</div>
                    <div class="value">${dealTypeA.includes('Hyperscaler') ? 'Low' : dealTypeA.includes('Capital') ? 'Medium' : 'High'}</div>
                    <div class="value">${dealTypeB.includes('Hyperscaler') ? 'Low' : dealTypeB.includes('Capital') ? 'Medium' : 'High'}</div>
                </div>
            `;
        }

        // ===== WIZARD =====
        let currentStep = 0;

        const wizardQuestions = [
            { catId: 'power', question: 'What is your grid connection?' },
            { catId: 'site', question: 'Do you have land secured?' },
            { catId: 'epc', question: 'Who will build the facility?' },
            { catId: 'offtake', question: 'Who is the customer?' },
            { catId: 'capital', question: "What's Crusoe's risk appetite?" }
        ];

        function renderWizardSteps() {
            const container = document.getElementById('wizardSteps');
            container.innerHTML = wizardQuestions.map((q, i) => {
                const cat = categories.find(c => c.id === q.catId);
                if (!cat) return '';
                const isComplete = hasCategoryCore(q.catId);
                const isActive = i === currentStep;
                const className = isActive ? 'active' : (isComplete ? 'complete' : '');
                return `
                    <div class="wizard-step ${className}" onclick="goToStep(${i})">
                        <span class="step-icon">${isComplete ? '✓' : (i + 1)}</span>
                        <span>${cat.name}</span>
                    </div>
                `;
            }).join('');
        }

        function renderWizardContent() {
            const q = wizardQuestions[currentStep];
            const cat = categories.find(c => c.id === q.catId);
            const container = document.getElementById('wizardContent');
            
            if (!cat) {
                container.innerHTML = '<p style="color: red;">Error: Category not found: ' + q.catId + '</p>';
                return;
            }
            
            let optionsHtml = '';
            
            if (cat.type === 'radio') {
                optionsHtml = cat.options.map(opt => {
                    const isSelected = state[opt.id];
                    let subOptionsHtml = '';
                    
                    if (isSelected && opt.subItems && opt.subItems.length > 0) {
                        subOptionsHtml = `
                            <div class="wizard-suboptions">
                                ${opt.subItems.map(sub => {
                                    // Check if this sub-item depends on another being selected
                                    if (sub.dependsOn && !state[sub.dependsOn]) {
                                        return '';
                                    }
                                    
                                    if (sub.type === 'select') {
                                        return `
                                            <div class="wizard-suboption">
                                                <span>${sub.label}:</span>
                                                <select onchange="updateSelect('${sub.id}', this.value)">
                                                    ${sub.options.map(o => `<option value="${o}" ${state[sub.id] === o ? 'selected' : ''}>${o}</option>`).join('')}
                                                </select>
                                            </div>
                                        `;
                                    } else if (sub.type === 'radio' && sub.radioGroup) {
                                        // Radio button within a group
                                        return `
                                            <label class="wizard-suboption radio-option ${state[sub.id] ? 'selected' : ''}" onclick="selectSubRadio('${sub.radioGroup}', '${sub.id}')">
                                                <span class="sub-radio ${state[sub.id] ? 'checked' : ''}"></span>
                                                <span>${sub.label}</span>
                                            </label>
                                        `;
                                    } else {
                                        return `
                                            <label class="wizard-suboption">
                                                <input type="checkbox" ${state[sub.id] ? 'checked' : ''} onchange="updateCheck('${sub.id}', this.checked)">
                                                <span>${sub.label}</span>
                                            </label>
                                        `;
                                    }
                                }).join('')}
                            </div>
                        `;
                    }
                    
                    return `
                        <div class="wizard-option ${isSelected ? 'selected' : ''}" onclick="selectWizardOption('${cat.id}', '${opt.id}')">
                            <div class="radio-circle"></div>
                            <div class="option-content">
                                <div class="option-label">${opt.label}</div>
                            </div>
                        </div>
                        ${subOptionsHtml}
                    `;
                }).join('');
            } else if (cat.type === 'simple') {
                optionsHtml = cat.items.map(item => {
                    const isChecked = state[item.id];
                    return `
                        <div class="wizard-option ${isChecked ? 'selected' : ''}" onclick="toggleSimpleOption('${item.id}')">
                            <div class="radio-circle"></div>
                            <div class="option-content">
                                <div class="option-label">${isChecked ? 'Yes' : 'No'} - ${item.label}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            container.innerHTML = `
                <div class="wizard-question">
                    <h3>${q.question}</h3>
                </div>
                <div class="wizard-options">
                    ${optionsHtml}
                </div>
            `;
            
            // Update nav buttons
            document.getElementById('prevBtn').disabled = currentStep === 0;
            const isLastStep = currentStep === wizardQuestions.length - 1;
            document.getElementById('nextBtn').style.display = isLastStep ? 'none' : 'inline-flex';
        }

        function selectWizardOption(catId, optId) {
            const cat = categories.find(c => c.id === catId);
            // Clear other options in this category
            cat.options.forEach(opt => {
                state[opt.id] = false;
                // Also clear sub-items when switching options
                if (opt.subItems) {
                    opt.subItems.forEach(sub => {
                        state[sub.id] = false;
                    });
                }
            });
            state[optId] = true;
            saveState();
            renderWizardSteps();
            renderWizardContent();
        }

        function selectSubRadio(radioGroup, selectedId) {
            // Find all sub-items in this radio group and clear them
            categories.forEach(cat => {
                cat.options.forEach(opt => {
                    if (opt.subItems) {
                        opt.subItems.forEach(sub => {
                            if (sub.radioGroup === radioGroup) {
                                state[sub.id] = (sub.id === selectedId);
                            }
                        });
                    }
                });
            });
            saveState();
            renderWizardContent();
        }

        function toggleSimpleOption(itemId) {
            state[itemId] = !state[itemId];
            saveState();
            renderWizardSteps();
            renderWizardContent();
        }

        function goToStep(step) {
            currentStep = step;
            renderWizardSteps();
            renderWizardContent();
        }

        function prevStep() {
            if (currentStep > 0) {
                currentStep--;
                renderWizardSteps();
                renderWizardContent();
            }
        }

        function nextStep() {
            if (currentStep < wizardQuestions.length - 1) {
                currentStep++;
                renderWizardSteps();
                renderWizardContent();
            } else {
                showResults();
            }
        }

        function showResults() {
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('resultsContent').style.display = 'block';
            renderResults();
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        function startAssessment() {
            document.getElementById('introSection').style.display = 'none';
            document.getElementById('wizardContainer').style.display = 'flex';
            document.getElementById('wizardContainer').style.animation = 'fadeIn 0.4s ease-out';
        }

        function restartWizard() {
            // Clear all state
            categories.forEach(cat => {
                if (cat.type === 'radio') {
                    cat.options.forEach(opt => {
                        state[opt.id] = false;
                        opt.subItems.forEach(sub => {
                            if (sub.type === 'select') {
                                state[sub.id] = sub.options[0];
                            } else {
                                state[sub.id] = false;
                            }
                        });
                    });
                } else if (cat.type === 'simple') {
                    cat.items.forEach(item => {
                        state[item.id] = false;
                    });
                }
            });
            saveState();
            currentStep = 0;
            renderWizardSteps();
            renderWizardContent();
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('resultsContent').style.display = 'none';
            document.getElementById('wizardContainer').style.display = 'none';
            document.getElementById('introSection').style.display = 'flex';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Initialize
        initState();
        renderWizardSteps();
        renderWizardContent();
        renderSavedScenarios();
    </script>
</body>
</html>
